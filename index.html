<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro&Beauty — Parrainage</title>
  <meta name="description" content="Programme de parrainage Pro&Beauty : inscrivez-vous et recevez votre code unique ou accédez à votre espace." />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --muted: #9fb0c3;
      --text: #eaf2fb;
      --accent: #5dd4a3;
      --accent-2: #87e6be;
      --error: #ff6b6b;
      --success: #64dfb8;
      --divider: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:#0b0f14;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{
      background:#121821;border:1px solid var(--divider);border-radius:18px;padding:20px;
      box-shadow:0 6px 30px rgba(0,0,0,.35)
    }
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .brandbox{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:8px;background:#0f141c;border:1px solid var(--stroke);object-fit:contain;padding:2px}
    h1{margin:4px 0 8px;font-size:26px}
    h2{margin:0 0 10px;font-size:18px}
    p.lead{margin:0 0 14px;color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:960px){.grid-2{grid-template-columns:1.1fr 1.4fr}}
    input,button{border-radius:12px}
    input[type="text"],input[type="email"],input[type="tel"]{
      width:100%;padding:12px 14px;background:#0f141c;border:1px solid var(--stroke);color:var(--text)
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .consent{display:flex;gap:10px;align-items:flex-start;font-size:13px;color:var(--muted)}
    .consent a{color:var(--accent)}
    .btn{background:var(--accent);color:#06281c;font-weight:700;border:none;padding:12px 16px;cursor:pointer}
    .btn:hover{background:var(--accent-2)}
    .muted{color:var(--muted)}
    .codebox{margin:18px 0;padding:14px;background:#0f141c;border:1px dashed var(--stroke)}
    .center{text-align:center}
    details.policy{margin-top:12px;padding:14px;background:#0f141c;border:1px solid var(--divider)}
    details.policy summary{cursor:pointer;color:var(--accent);font-weight:600}
    .bar{display:grid;gap:10px;align-items:center}
    @media(min-width:780px){.bar{grid-template-columns:1fr auto}}
    .msg{font-size:14px;margin-top:6px}
    .msg.error{color:var(--error)} .msg.ok{color:var(--success)}
    .section-title{margin:24px 0 10px;color:var(--muted);font-size:13px;text-transform:uppercase;letter-spacing:.08em}
    .divider{height:1px;background:var(--divider);margin:16px 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">

    <!-- ACCÈS À L’ESPACE (EN TÊTE) -->
    <div class="card" id="quickLoginCard" style="margin-bottom:16px">
      <header>
        <div class="brandbox">
          <img class="logo" src="./Logo Pro&Beauty.png" alt="Pro&Beauty">
          <div>
            <div style="font-weight:800">Pro&Beauty</div>
            <div class="muted" style="font-size:13px">Programme de parrainage</div>
          </div>
        </div>
      </header>

      <h2>Accéder à mon espace</h2>
      <p class="lead">Entrez votre email professionnel pour recevoir un <b>lien magique</b> de connexion (valable 10&nbsp;minutes).</p>
      <div class="bar">
        <input id="quick_email" type="email" placeholder="Votre email (commercial)" autocomplete="email" />
        <button id="quick_btn" class="btn">Recevoir le lien</button>
      </div>
      <div id="quick_msg" class="msg muted" role="status" aria-live="polite"></div>
    </div>

    <!-- FORMULAIRE D’INSCRIPTION -->
    <div class="card" id="step1">
      <h1>Inscription au programme</h1>
      <p class="lead">Créez votre profil et recevez votre <b>code parrain</b> à partager à vos clientes et partenaires.</p>

      <form id="referral-form" novalidate>
        <div class="row">
          <div>
            <label for="first_name" class="muted">Prénom</label>
            <input id="first_name" name="first_name" type="text" placeholder="Jean" required />
          </div>
          <div>
            <label for="last_name" class="muted">Nom</label>
            <input id="last_name" name="last_name" type="text" placeholder="Dupont" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="email" class="muted">Email</label>
            <input id="email" name="email" type="email" placeholder="jean.dupont@mail.com" required />
          </div>
          <div>
            <label for="phone" class="muted">Téléphone</label>
            <input id="phone" name="phone" type="tel" placeholder="06 12 34 …" required />
          </div>
        </div>

        <label for="brand" class="muted">Marque d’origine (optionnel)</label>
        <input id="brand" name="brand" type="text" placeholder="Ex. CosméNova" />

        <label for="sponsor" class="muted">Code parrain (commercial) — optionnel</label>
        <input id="sponsor" name="sponsor" type="text" placeholder="Ex. PNB-AB1234" />

        <div class="consent">
          <input id="consent" type="checkbox" required aria-label="Consentement RGPD" />
          <label for="consent">J’accepte d’être contacté dans le cadre du programme et j’ai lu la
            <a href="#" onclick="document.getElementById('policy').open=true;return false;">politique de confidentialité</a>.
          </label>
        </div>

        <button class="btn" type="submit">Valider et générer mon code</button>
        <div id="msg" class="msg error" role="alert" aria-live="polite"></div>

        <details id="policy" class="policy">
          <summary>Politique de confidentialité — aperçu</summary>
          <p><b>Responsable :</b> Pro&Beauty — service-clients@proandbeauty.com</p>
          <p><b>Données :</b> identité, contact, code, parrain éventuel, dates.</p>
          <p><b>Finalités :</b> gestion du programme et communications associées.</p>
          <p><b>Base légale :</b> consentement et intérêt légitime.</p>
          <p><b>Durée :</b> 24 mois après dernière interaction, puis suppression/anonymisation.</p>
        </details>
      </form>
    </div>

    <!-- ÉTAPE 2 : code généré -->
    <div class="card center" id="step2" style="display:none">
      <h1>Votre code parrain</h1>
      <p class="lead">Partagez ce code. Lors de l’inscription, vos contacts n’auront qu’à le saisir.</p>
      <div id="code" class="codebox">PNB-XXXXXX</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="btn" id="copyBtn">Copier</button>
        <button class="btn" id="qrBtn">Afficher le QR code</button>
      </div>
      <canvas id="qrcanvas" style="display:none;margin:16px auto;width:180px;height:180px"></canvas>
      <div class="divider"></div>
      <p class="muted" style="font-size:12px">Un email de confirmation peut vous être envoyé ultérieurement.</p>
    </div>

  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // ===== CONFIG SUPABASE =====
  const SUPABASE_URL = "https://tpwkptzlhxitllugmlho.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwd2twdHpsaHhpdGxsdWdtbGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTgzMTAsImV4cCI6MjA3NjA5NDMxMH0.zm782jT62rG7WzuPs7FL0Kv9oizkArvOCPLUoGYh3nw";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== Génération code parrain =====
  const slug2 = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z]/g,'');
  const rand4 = () => Math.floor(Math.random()*10000).toString().padStart(4,'0');
  function checksum(str){let sum=0;for(const c of str){sum+=c.charCodeAt(0)}return String(sum%97).padStart(2,'0')}
  function makeReferralCode(first,last){
    const p=(slug2(first).slice(0,2)||'XX'); const n=(slug2(last).slice(0,2)||'YY');
    const base=`${p}${n}${rand4()}`; return `PNB-${base}${checksum(base)}`
  }

  // ===== FORMULAIRE INSCRIPTION =====
  const form = document.getElementById('referral-form');
  const msg  = document.getElementById('msg');
  const step1= document.getElementById('step1');
  const step2= document.getElementById('step2');
  const codeBox = document.getElementById('code');
  const copyBtn = document.getElementById('copyBtn');
  const qrBtn   = document.getElementById('qrBtn');
  const qrCanvas= document.getElementById('qrcanvas');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = 'Enregistrement...';

    const first_name = document.getElementById('first_name').value.trim();
    const last_name  = document.getElementById('last_name').value.trim();
    const email      = document.getElementById('email').value.trim();
    const phone      = document.getElementById('phone').value.trim();
    const brand      = document.getElementById('brand').value.trim() || null;
    const sponsor    = document.getElementById('sponsor').value.trim() || null;
    const consent    = document.getElementById('consent').checked;

    if(!first_name || !last_name){ msg.textContent='Prénom et nom requis.'; return; }
    if(!email || !phone){ msg.textContent='Email et téléphone requis.'; return; }
    if(!consent){ msg.textContent='Merci d’accepter la mention RGPD.'; return; }

    const referral_code = makeReferralCode(first_name,last_name);

    const { error } = await supabase.from('referrers')
      .insert([{ first_name,last_name,email,phone,source_brand:brand,referral_code,parent_code:sponsor }]);
    if(error){ msg.textContent='Erreur d’enregistrement'; console.error(error); return; }

    try{
      const r = await fetch('/api/send-confirmation',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, first_name, referral_code })
      });
      if(!r.ok){ console.warn('send-confirmation failed', await r.text()); }
    }catch(e){ console.warn(e); }

    codeBox.textContent = referral_code;
    step1.style.display='none'; step2.style.display='block';
  });

  // ===== QR / COPIE =====
  qrBtn.addEventListener('click', ()=>{
    qrCanvas.style.display='block';
    QRCode.toCanvas(qrCanvas, 'https://www.proandbeauty.com', { width:180, margin:1 }, err=>{ if(err)console.error(err) })
  });
  copyBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(codeBox.textContent); alert('Code copié'); }catch{}
  });
  </script>

  <!-- ===== CONNEXION RAPIDE PAR MAIL (version finale, unique) ===== -->
  <script>
    (function () {
      const emailInput = document.getElementById('quick_email');
      const btn = document.getElementById('quick_btn');
      const msg = document.getElementById('quick_msg');

      // couleurs cohérentes avec la charte
      const COLOR_SUCCESS = '#5dd4a3';
      const COLOR_ERROR = '#ff8686';
      const COLOR_NEUTRAL = '#eaf2fb';

      function setMsg(text, color, asHTML = false) {
        if (asHTML) { msg.innerHTML = text; } else { msg.textContent = text; }
        msg.style.color = color || COLOR_NEUTRAL;
      }

      function disableUI(disabled) {
        btn.disabled = disabled;
        emailInput.disabled = disabled;
        btn.style.opacity = disabled ? '0.7' : '1';
        btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
      }

      function isValidEmail(v) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
      }

      async function sendQuickLink() {
        const email = String(emailInput.value || '').trim().toLowerCase();

        // reset message
        setMsg('Envoi en cours...', COLOR_NEUTRAL);

        // validation simple
        if (!email) {
          setMsg('Veuillez saisir votre email.', COLOR_ERROR);
          return;
        }
        if (!isValidEmail(email)) {
          setMsg('Adresse email invalide.', COLOR_ERROR);
          return;
        }

        disableUI(true);

        try {
          const res = await fetch('/api/auth/request-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json().catch(() => ({}));

          // Mode actuel de l'API : 200 avec { ok:true, found:true|false }
          if (res.ok && data && data.ok === true) {
            if (data.found === true) {
              setMsg('Lien envoyé ✔ Vérifiez votre boîte mail.', COLOR_SUCCESS);
            } else {
              setMsg(
                "Cet email n'existe pas dans notre base.<br/>👉 <a href='#step1' style='color:#87e6be;text-decoration:underline;'>Créer un compte</a>",
                COLOR_ERROR,
                true
              );
            }
            return;
          }

          // Si un jour tu actives les erreurs 404 (USER_NOT_FOUND)
          if (res.status === 404 && data && data.code === 'USER_NOT_FOUND') {
            setMsg(
              "Cet email n'existe pas dans notre base.<br/>👉 <a href='#step1' style='color:#87e6be;text-decoration:underline;'>Créer un compte</a>",
              COLOR_ERROR,
              true
            );
            return;
          }

          // Fallback générique
          setMsg("Impossible d'envoyer le lien pour le moment. Réessayez plus tard.", COLOR_ERROR);
        } catch (e) {
          setMsg('Erreur réseau. Vérifiez votre connexion.', COLOR_ERROR);
        } finally {
          disableUI(false);
        }
      }

      // Clic bouton
      btn.addEventListener('click', sendQuickLink);

      // Entrée clavier
      emailInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendQuickLink();
        }
      });
    })();
  </script>

</body>
</html>
