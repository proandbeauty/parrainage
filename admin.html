<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro&Beauty — Admin (Commissions & RIB)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --text:#eaf2fb; --muted:#9fb0c3;
      --stroke:rgba(255,255,255,.12); --divider:rgba(255,255,255,.08);
      --accent:#5dd4a3; --accent-2:#87e6be; --red:#ff6b6b;
      --green:#38d39f; --amber:#ffd166;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:30px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:18px;margin-bottom:14px}
    h1,h2{margin:6px 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input,select{background:#0f141c;border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:10px}
    button{background:var(--accent);border:none;color:#06281c;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer;transition:opacity .15s}
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#0f141c;border:1px solid var(--stroke);color:#eaf2fb}
    .btn-red{background:var(--red);color:#1b0b0b}
    .btn-red:hover{filter:brightness(1.05)}
    .btn-done{background:#0f141c;border:1px solid var(--divider);color:var(--muted);cursor:default}
    .btn-done:hover{background:#0f141c}

    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid var(--divider);padding:8px;vertical-align:top}
    th{color:#9fb0c3;text-align:left}
    .muted{color:#9fb0c3}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141c;border:1px solid rgba(255,255,255,.15);font-size:12px}
    .pill.ok{border-color:rgba(93,212,163,.6);color:#9bf0cf}
    .pill.warn{border-color:rgba(255,209,102,.6);color:#ffe6ad}
    .pill.bad{border-color:rgba(255,107,107,.6);color:#ffb3b3}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{background:#0f141c;border:1px solid var(--stroke);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab.active{background:var(--accent);color:#06281c;border-color:transparent;font-weight:800}
    .hide{display:none !important}

    /* Ligne flash (succès / rejet) */
    tr.flash-ok{animation: flashok 1.4s ease-out}
    tr.flash-bad{animation: flashbad 1.4s ease-out}
    @keyframes flashok { 0%{background:rgba(56,211,159,.25)} 100%{background:transparent} }
    @keyframes flashbad { 0%{background:rgba(255,107,107,.25)} 100%{background:transparent} }

    /* Toast */
    .toastbox{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{
      background:#0f141c;border:1px solid var(--divider);color:var(--text);
      padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex;align-items:center;gap:8px;min-width:220px
    }
    .toast.ok .dot{width:10px;height:10px;border-radius:50%;background:var(--green)}
    .toast.bad .dot{width:10px;height:10px;border-radius:50%;background:var(--red)}
    .toast .label{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin — Pro&Beauty</h1>

      <!-- Bandeau commun -->
      <div class="row">
        <input id="adm_token" type="password" placeholder="ADMIN_TOKEN (obligatoire)" style="min-width:260px" />
        <input id="adm_search" type="text" placeholder="Recherche globale (nom, email, code, commande, IBAN…)" style="flex:1" />
        <button id="adm_reload" class="btn-ghost">Recharger</button>
      </div>
      <div id="adm_msg" class="muted" style="margin-bottom:8px"></div>

      <!-- Onglets -->
      <div class="tabs">
        <button class="tab active" data-tab="tab_comm">Commissions</button>
        <button class="tab" data-tab="tab_rib">RIB</button>
        <button class="tab" data-tab="tab_sales">Ventes / Clients</button>
        <button class="tab" data-tab="tab_refs">Bénéficiaires</button>
      </div>

      <!-- === COMMISSIONS === -->
      <section id="tab_comm">
        <div class="row">
          <select id="comm_status">
            <option value="all">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="approved">Approuvé</option>
            <option value="paid">Payé</option>
          </select>
          <button id="comm_export" class="btn-ghost">Exporter CSV</button>
          <div class="muted" id="comm_hint"></div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Commission</th>
              <th>Bénéficiaire</th>
              <th>Vente</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="comm_tbody"><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
        </table>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="comm_more">Charger +</button>
        </div>
      </section>

      <!-- === RIB === -->
      <section id="tab_rib" class="hide">
        <div class="row">
          <select id="rib_status">
            <option value="all">Tous</option>
            <option value="pending">En attente</option>
            <option value="approved">Validé</option>
            <option value="rejected">Rejeté</option>
          </select>
          <button id="rib_export" class="btn-ghost">Exporter CSV</button>
          <div class="muted" id="rib_hint"></div>
        </div>
        <table>
          <thead>
            <tr>
              <th data-sort="created_at" style="cursor:pointer">RIB ▲▼</th>
              <th data-sort="referrer">Titulaire</th>
              <th data-sort="holder_name" style="cursor:pointer">IBAN (titulaire) ▲▼</th>
              <th>Justificatif</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rib_tbody"><tr><td colspan="5" class="muted">Chargement…</td></tr></tbody>
        </table>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="rib_more">Charger +</button>
        </div>
      </section>

      <!-- === VENTES === -->
      <section id="tab_sales" class="hide">
        <div class="row">
          <input id="sales_from" type="date" />
          <input id="sales_to" type="date" />
          <input id="sales_cp" type="text" placeholder="Code postal contient…" style="min-width:160px" />
          <input id="sales_amt_min" type="number" step="0.01" placeholder="Montant min" style="min-width:140px" />
          <input id="sales_amt_max" type="number" step="0.01" placeholder="Montant max" style="min-width:140px" />
          <button id="sales_export" class="btn-ghost">Exporter CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>N° commande</th>
              <th>Institut</th>
              <th>Professionnel</th>
              <th>Code postal</th>
              <th>Montant</th>
            </tr>
          </thead>
          <tbody id="sales_tbody"><tr><td colspan="6" class="muted">Chargement…</td></tr></tbody>
        </table>
      </section>

      <!-- === BENEFICIAIRES === -->
      <section id="tab_refs" class="hide">
        <div class="row">
          <select id="refs_rib">
            <option value="all">RIB: Tous</option>
            <option value="approved">RIB validé</option>
            <option value="pending">RIB en attente</option>
            <option value="rejected">RIB rejeté</option>
            <option value="missing">RIB manquant</option>
          </select>
          <input id="refs_from" type="date" />
          <input id="refs_to" type="date" />
          <input id="refs_q" type="text" placeholder="Nom/Email/Code contient…" style="flex:1" />
          <button id="refs_export" class="btn-ghost">Exporter CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Commercial</th>
              <th>Email</th>
              <th>Code</th>
              <th>Statut RIB</th>
              <th>Dernière activité</th>
            </tr>
          </thead>
          <tbody id="refs_tbody"><tr><td colspan="5" class="muted">Chargement…</td></tr></tbody>
        </table>
      </section>

    </div>
  </div>

  <!-- Toast container -->
  <div class="toastbox" id="toastbox"></div>

  <script>
    // --------- Helpers ----------
    const $ = q => document.querySelector(q);
    const debounce = (fn, ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function showToast(text, ok=true){
      const box = $('#toastbox');
      const div = document.createElement('div');
      div.className = 'toast ' + (ok ? 'ok' : 'bad');
      div.innerHTML = `<span class="dot"></span><span class="label">${text}</span>`;
      box.appendChild(div);
      setTimeout(()=>{ div.style.opacity=.9 },10);
      setTimeout(()=>{ div.style.opacity=0; div.style.transform='translateY(-6px)'; }, 2200);
      setTimeout(()=>{ div.remove(); }, 2600);
    }

    // ---- Utils pour téléchargement CSV sécurisé + petit helper date ----
    async function downloadCsvFrom(url, filename) {
      try{
        const res = await fetch(url, { headers: auth() });
        if (!res.ok) { showToast('Export impossible', false); return; }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }catch(_){ showToast('Export impossible', false); }
    }
    function todayStr(){ return new Date().toISOString().slice(0,10); }

    function setPill(el, status){
  el.textContent = status;
  el.classList.remove('ok','warn','bad');
  if (status==='approved' || status==='paid' || status==='validé') el.classList.add('ok');
  else if (status==='pending' || status==='en attente') el.classList.add('warn');
  else if (status==='rejected') el.classList.add('bad');
}

    const admTokenEl = $('#adm_token');
    const admSearchEl = $('#adm_search');
    const admMsg = $('#adm_msg');
    const tabs = document.querySelectorAll('.tab');

    admTokenEl.value = localStorage.getItem('pnb_admin_token') || '';
    admTokenEl.addEventListener('change', ()=> localStorage.setItem('pnb_admin_token', admTokenEl.value.trim()));

    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('section[id^="tab_"]').forEach(s=>s.classList.add('hide'));
        document.getElementById(btn.dataset.tab).classList.remove('hide');
      });
    });

    $('#adm_reload').addEventListener('click', ()=> { loadAll(true); });
    admSearchEl.addEventListener('input', debounce(()=> loadAll(true), 400));
    admTokenEl.addEventListener('input', debounce(()=> loadAll(true), 300));

    function token(){ return (admTokenEl.value || '').trim(); }
    function auth(){ return { Authorization: 'Bearer '+token() }; }

    // ====== COMMISSIONS ======
    const commTbody = $('#comm_tbody');
    const commStatusEl = $('#comm_status');
    const commMoreBtn = $('#comm_more');
    const commExportBtn = $('#comm_export');
    const commHint = $('#comm_hint');

    let commPage=1, commLimit=50, commHasMore=true, commOffset=0, commLastBatch=[];

    commStatusEl.addEventListener('change', ()=> loadCommissions(true));

    function commNormalize(item){
      if (!item.beneficiary && !item.sale) {
        return {
          id: item.commission_id || item.id,
          amount: item.commission_amount ?? item.amount,
          currency: item.commission_currency ?? item.currency,
          status: item.status,
          role: item.role,
          created_at: item.commission_created_at || item.created_at,
          beneficiary: { first_name:item.first_name, last_name:item.last_name, email:item.email, referral_code:item.referral_code },
          sale: { id:item.sale_id, order_id:item.order_id, amount:item.sale_amount, currency:item.sale_currency, created_at:item.sale_created_at }
        };
      }
      return item;
    }

    async function loadCommissions(reset=true){
      try{
        if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
        if(reset){ commPage=1; commHasMore=true; commOffset=0; commTbody.innerHTML='<tr><td colspan="4" class="muted">Chargement…</td></tr>'; }

        const base='/api/admin/list-commissions';
        const p={ search:admSearchEl.value.trim(), page:String(commPage), limit:String(commLimit) };
        if(commStatusEl.value!=='all') p.status=commStatusEl.value;
        let url=`${base}?${new URLSearchParams(p).toString()}`;
        let r=await fetch(url,{ headers:auth() });

        if(r.status===400||r.status===404||r.status===422){
          const p2={ search:admSearchEl.value.trim(), limit:String(commLimit), offset:String(commOffset) };
          if(commStatusEl.value!=='all') p2.status=commStatusEl.value;
          url=`${base}?${new URLSearchParams(p2).toString()}`;
          r=await fetch(url,{ headers:auth() });
        }

        const j=await r.json();
        if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; }
        admMsg.textContent='';

        const items=Array.isArray(j.items)?j.items:(Array.isArray(j.rows)?j.rows:[]);
        commLastBatch=items.map(commNormalize);
        if(reset) commTbody.innerHTML='';

        if(commLastBatch.length===0 && (commPage===1||commOffset===0)){
          commTbody.innerHTML='<tr><td colspan="4" class="muted">Aucune commission.</td></tr>';
        }else{
          for(const c of commLastBatch){
            const b=c.beneficiary||{}, s=c.sale||{};
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>
                <div><b>${Number(c.amount).toFixed(2)} ${c.currency||''}</b>
                  <span class="pill ${c.status==='paid'?'ok':c.status==='approved'?'ok':c.status==='pending'?'warn':''}" data-pill="status">${c.status}</span>
                  <span class="pill">${c.role}</span>
                </div>
                <div class="muted">${c.created_at?new Date(c.created_at).toLocaleString():''}</div>
                <div class="muted">ID: ${c.id||''}</div>
              </td>
              <td>
                <div><b>${(b.first_name||'')+' '+(b.last_name||'')}</b></div>
                <div class="muted">${b.email||''}</div>
                <div class="muted">Code: ${b.referral_code||''}</div>
              </td>
              <td>
                <div>Commande: <b>${s.order_id||'-'}</b></div>
                <div class="muted">Montant: ${s.amount!=null?Number(s.amount).toFixed(2)+' '+(s.currency||''):'-'}</div>
                <div class="muted">${s.created_at?new Date(s.created_at).toLocaleString():''}</div>
              </td>
              <td>
                ${c.status==='approved'||c.status==='paid'
                  ? '<button class="btn-done" disabled>Approuvé ✓</button>'
                  : `<button class="btn-ghost" data-comm="approved" data-id="${c.id}">Approuver</button>`}
                ${c.status==='paid'
                  ? '<button class="btn-done" disabled>Payé ✓</button>'
                  : `<button class="btn-red" data-comm="paid" data-id="${c.id}">Marquer payé</button>`}
              </td>`;
            commTbody.appendChild(tr);
          }
        }

        if(typeof j.hasMore==='boolean'){ commHasMore=j.hasMore; if(commHasMore) commPage+=1; }
        else{ commOffset=j.nextOffset!=null?j.nextOffset:(commOffset+commLastBatch.length); commHasMore=commLastBatch.length===commLimit; if(!commHasMore) commPage+=1; }

        commMoreBtn.disabled=!commHasMore;
        commMoreBtn.textContent=commHasMore?'Charger +':'Plus de résultats';
        commHint.textContent=`Page ${commPage-1}`;
      }catch(e){ admMsg.textContent='Erreur chargement (commissions)'; console.error(e); }
    }

    function updateCommissionRowUI(btn, newStatus){
      const tr = btn.closest('tr');
      const pill = tr.querySelector('[data-pill="status"]');
      setPill(pill, newStatus);
      const [b1, b2] = tr.querySelectorAll('td:last-child button');
      if(newStatus === 'approved'){
        if(b1){ b1.textContent='Approuvé ✓'; b1.className='btn-done'; b1.disabled=true; }
        tr.classList.add('flash-ok');
      }
      if(newStatus === 'paid'){
        if(b2){ b2.textContent='Payé ✓'; b2.className='btn-done'; b2.disabled=true; }
        if(b1){ b1.textContent='Approuvé ✓'; b1.className='btn-done'; b1.disabled=true; }
        tr.classList.add('flash-ok');
      }
      setTimeout(()=> tr.classList.remove('flash-ok','flash-bad'),1500);
    }

    commTbody.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-comm]'); if(!btn) return;
      const id = btn.dataset.id, to = btn.dataset.comm;
      btn.disabled = true; btn.style.opacity = .7;
      fetch('/api/admin/set-commission-status',{
        method:'POST',headers:{'Content-Type':'application/json',...auth()},body:JSON.stringify({commission_id:id,status:to})
      })
        .then(r=>r.json().then(j=>({ok:r.ok,j})))
        .then(({ok,j})=>{
          if(!ok){ btn.disabled=false; btn.style.opacity=1; showToast(j.error||'Erreur', false); return; }
          updateCommissionRowUI(btn, to);
          showToast(to==='approved'?'Commission approuvée ✅':'Commission marquée payée 💸', true);
        })
        .catch(()=>{ btn.disabled=false; btn.style.opacity=1; showToast('Erreur réseau', false); });
    });

    commMoreBtn.addEventListener('click', ()=>{ if(commHasMore) loadCommissions(false); });
// Export Commissions : essaye l'API CSV, sinon fallback local (pagination list-commissions)
commExportBtn.addEventListener('click', async ()=>{
  try{
    const p = {
      search: admSearchEl.value.trim(),
      ...(commStatusEl.value!=='all' ? { status: commStatusEl.value } : {})
    };
    const url = `/api/admin/export-commissions?${new URLSearchParams(p).toString()}`;
    const res = await fetch(url, { headers: auth() });
    if (res.ok) {
      const csv = '\uFEFF' + lines.join('\r\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `export-commissions-${todayStr()}.csv`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      return;
    }
  } catch (_) { /* on tentera le fallback */ }

  // Fallback local
  try {
    const rows = await fetchAllCommissionsForExport();
    if (!rows.length) { showToast('Aucune commission à exporter', false); return; }

    const head = [
      'date','commission_id','status','role','amount','currency',
      'beneficiary_name','beneficiary_email','referral_code',
      'order_id','sale_amount','sale_currency','sale_date'
    ];
    const lines = [head.join(';')];

    for (const c of rows) {
      const b = c.beneficiary || {};
      const s = c.sale || {};
      const vals = [
        c.created_at ? new Date(c.created_at).toLocaleString() : '',
        c.id || '', c.status || '', c.role || '',
        (c.amount!=null ? Number(c.amount).toFixed(2) : ''), (c.currency || ''),
        `${(b.first_name||'')+' '+(b.last_name||'')}`.trim(), (b.email||''), (b.referral_code||''),
        (s.order_id||''), (s.amount!=null ? Number(s.amount).toFixed(2) : ''), (s.currency||''),
        s.created_at ? new Date(s.created_at).toLocaleString() : ''
      ].map(x => `"${String(x).replace(/"/g,'""')}"`);
      lines.push(vals.join(';'));
    }

    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `export-commissions-${todayStr()}.csv`;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
  } catch (e) {
    console.error(e);
    showToast('Export impossible', false);
  }
});

// Récupère toutes les commissions en paginant (supporte page/limit OU offset/limit)
async function fetchAllCommissionsForExport() {
  const out = [];
  // 1) tentative page/limit
  let page = 1, limit = 200, keep = true;
  while (keep && page <= 500) { // garde-fou
    const p = { search: admSearchEl.value.trim(), page: String(page), limit: String(limit) };
    if (commStatusEl.value !== 'all') p.status = commStatusEl.value;
    const url = `/api/admin/list-commissions?${new URLSearchParams(p).toString()}`;
    const r = await fetch(url, { headers: auth() });
    if (r.status === 400 || r.status === 404 || r.status === 422) { keep = false; break; } // on passera à offset/limit
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Erreur liste commissions');
    const batch = Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
    out.push(...batch.map(commNormalize));
    if (j.hasMore === false || batch.length < limit) break;
    page++;
  }
  if (out.length) return out;

  // 2) fallback offset/limit
  let offset = 0; keep = true;
  while (keep && offset <= 20000) {
    const p = { search: admSearchEl.value.trim(), offset: String(offset), limit: '500' };
    if (commStatusEl.value !== 'all') p.status = commStatusEl.value;
    const url = `/api/admin/list-commissions?${new URLSearchParams(p).toString()}`;
    const r = await fetch(url, { headers: auth() });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Erreur liste commissions (offset)');
    const batch = Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
    out.push(...batch.map(commNormalize));
    if (!batch.length) break;
    offset = j.nextOffset != null ? j.nextOffset : (offset + batch.length);
  }
  return out;
}


    // ====== RIB ======
    const ribTbody=$('#rib_tbody'), ribStatusEl=$('#rib_status'), ribMoreBtn=$('#rib_more'), ribExportBtn=$('#rib_export'), ribHint=$('#rib_hint');
    let ribOffset=0, ribLastBatch=[], ribSortBy='created_at', ribSortDir='desc';

    function maskIban(iban){ if(!iban) return ''; const c=String(iban).replace(/\s+/g,''); if(c.length<=8) return c; return c.slice(0,4)+' •••• •••• •••• '+c.slice(-4); }
    function refreshRibHeaders(){
      const thC=document.querySelector('th[data-sort="created_at"]'); const thH=document.querySelector('th[data-sort="holder_name"]');
      const up=' ▲',down=' ▼'; if(thC) thC.textContent='RIB'+(ribSortBy==='created_at'?(ribSortDir==='asc'?up:down):' ▲▼');
      if(thH) thH.textContent='IBAN (titulaire)'+(ribSortBy==='holder_name'?(ribSortDir==='asc'?up:down):' ▲▼');
    }
    ribStatusEl.addEventListener('change', ()=> loadRibs(true));

    async function loadRibs(reset=true){
      try{
        if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
        if(reset){ ribOffset=0; ribTbody.innerHTML='<tr><td colspan="5" class="muted">Chargement…</td></tr>'; }
        const url=`/api/admin/ribs-list?status=${encodeURIComponent(ribStatusEl.value)}&limit=50&offset=${ribOffset}&search=${encodeURIComponent(admSearchEl.value.trim())}&sort_by=${encodeURIComponent(ribSortBy)}&order=${encodeURIComponent(ribSortDir)}`;
        const r=await fetch(url,{ headers:auth() }); const j=await r.json();
        if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; } admMsg.textContent='';

        if(reset) ribTbody.innerHTML=''; ribLastBatch=j.items||[];
        if(ribLastBatch.length===0 && ribOffset===0){ ribTbody.innerHTML='<tr><td colspan="5" class="muted">Aucun RIB.</td></tr>'; }
        else{
          for(const row of ribLastBatch){
            const ref=row.referrer||{}; const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>
                <div><b>${row.id}</b> <span class="pill ${row.status==='approved'?'ok':row.status==='pending'?'warn':row.status==='rejected'?'bad':''}" data-pill="rib">${row.status}</span></div>
                <div class="muted">${row.created_at?new Date(row.created_at).toLocaleString():''}</div>
              </td>
              <td><div><b>${(ref.first_name||'')+' '+(ref.last_name||'')}</b></div><div class="muted">${ref.email||''}</div><div class="muted">Code: ${ref.referral_code||''}</div></td>
              <td><div><b>${maskIban(row.iban_masked||row.iban||'')}</b></div><div class="muted">${row.bic?('BIC: '+row.bic):''}</div><div class="muted">${row.holder_name?('Titulaire: '+row.holder_name):''}</div></td>
              <td>${row.doc_path?`<button class="btn-ghost" data-proof="${row.id}">Voir justificatif</button>`:'<span class="muted">—</span>'}</td>
              <td>
                ${row.status==='approved'
                  ? '<button class="btn-done" disabled>Validé ✓</button>'
                  : `<button class="btn-ghost" data-rib="approved" data-id="${row.id}">Valider</button>`}
                ${row.status==='rejected'
                  ? '<button class="btn-done" disabled>Rejeté ✓</button>'
                  : `<button class="btn-red" data-rib="rejected" data-id="${row.id}">Rejeter</button>`}
              </td>`;
            ribTbody.appendChild(tr);
          }
        }
        ribOffset=j.nextOffset ?? (ribOffset+ribLastBatch.length);
        refreshRibHeaders(); ribHint.textContent=`Offset ${ribOffset}`;
      }catch(e){ admMsg.textContent='Erreur chargement (RIB)'; console.error(e); }
    }

    function updateRibRowUI(btn, newStatus){
      const tr = btn.closest('tr');
      const pill = tr.querySelector('[data-pill="rib"]');
      setPill(pill, newStatus);
      const [b1, b2] = tr.querySelectorAll('td:last-child button');
      if(newStatus==='approved'){
        if(b1){ b1.textContent='Validé ✓'; b1.className='btn-done'; b1.disabled=true; }
        if(b2){ b2.classList.remove('btn-done'); b2.disabled=false; }
        tr.classList.add('flash-ok'); showToast('RIB validé ✅', true);
      } else if(newStatus==='rejected'){
        if(b2){ b2.textContent='Rejeté ✓'; b2.className='btn-done'; b2.disabled=true; }
        if(b1){ b1.className='btn-ghost'; b1.disabled=false; b1.textContent='Valider'; }
        tr.classList.add('flash-bad'); showToast('RIB rejeté ❌', false);
      }
      setTimeout(()=> tr.classList.remove('flash-ok','flash-bad'),1500);
    }

    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{ const col=th.getAttribute('data-sort'); if(col==='referrer') return;
        if(ribSortBy===col) ribSortDir=(ribSortDir==='asc'?'desc':'asc'); else { ribSortBy=col; ribSortDir='asc'; }
        loadRibs(true);
      });
    });

    ribTbody.addEventListener('click', (e)=>{
      const p=e.target.closest('button[data-proof]'); if(p){ openProof(p.dataset.proof); return; }
      const b=e.target.closest('button[data-rib]'); if(!b) return;
      const id=b.dataset.id, to=b.dataset.rib;
      b.disabled=true; b.style.opacity=.7;
      fetch('/api/admin/ribs-set-status',{method:'POST',headers:{'Content-Type':'application/json',...auth()},body:JSON.stringify({id,status:to,note:''})})
        .then(r=>r.json().then(j=>({ok:r.ok,j})))
        .then(({ok,j})=>{
          if(!ok){ b.disabled=false; b.style.opacity=1; showToast(j.error||'Erreur', false); return; }
          updateRibRowUI(b, to);
        })
        .catch(()=>{ b.disabled=false; b.style.opacity=1; showToast('Erreur réseau', false); });
    });

    async function openProof(rib_id){
      try{
        if (!token()) { alert('Saisissez le token admin.'); return; }
        const r = await fetch(`/api/admin/ribs-proof?id=${encodeURIComponent(rib_id)}`, { headers: auth() });
        const text = await r.text();
        let j = {};
        try { j = text ? JSON.parse(text) : {}; } catch { j = { error: text || '' }; }
        if (!r.ok) {
          const msg = (j.error || `Erreur HTTP ${r.status}`) + (j.detail ? `\n${j.detail}` : '');
          alert(msg || 'Justificatif indisponible');
          return;
        }
        if (!j.url) { alert('Lien justificatif manquant.'); return; }
        window.open(j.url, '_blank', 'noopener');
      }catch(e){
        console.error('openProof error:', e);
        alert('Impossible d’ouvrir le justificatif.');
      }
    }

    ribMoreBtn.addEventListener('click', ()=> loadRibs(false));
    ribExportBtn.addEventListener('click', async ()=>{
      const p = {
        status: ribStatusEl.value,
        search: admSearchEl.value.trim(),
        sort_by: ribSortBy,
        order: ribSortDir,
        limit: '10000',
        offset: '0',
        format: 'csv'
      };
      const url = `/api/admin/ribs-list?${new URLSearchParams(p).toString()}`;
      await downloadCsvFrom(url, `export-ribs-${todayStr()}.csv`);
    });

    // ====== VENTES ======
    const salesTbody=$('#sales_tbody');
    const salesFrom=$('#sales_from'), salesTo=$('#sales_to'), salesCP=$('#sales_cp'), salesMin=$('#sales_amt_min'), salesMax=$('#sales_amt_max');
    const salesExportBtn=$('#sales_export');
    const reloadSalesDebounced = debounce(()=> loadSales(true), 400);
    [salesFrom,salesTo,salesCP,salesMin,salesMax].forEach(el=> el.addEventListener('input', reloadSalesDebounced));

    let salesOffset=0, salesLimit=100, salesRows=[];

    async function loadSales(reset=true){
      try{
        if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
        if(reset){ salesOffset=0; salesRows=[]; salesTbody.innerHTML='<tr><td colspan="6" class="muted">Chargement…</td></tr>'; }

        const qs=new URLSearchParams({
          search: admSearchEl.value.trim(),
          date_from: salesFrom.value || '',
          date_to: salesTo.value || '',
          postal: salesCP.value || '',
          amount_min: salesMin.value || '',
          amount_max: salesMax.value || '',
          limit: String(salesLimit),
          offset: String(salesOffset)
        }).toString();

        const r=await fetch(`/api/admin/list-sales?${qs}`,{ headers:auth() });
        const j=await r.json();
        if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; }
        if(reset) salesTbody.innerHTML='';

        const batch=j.items||[];
        salesRows = reset ? batch : salesRows.concat(batch);

        if(salesRows.length===0){
          salesTbody.innerHTML='<tr><td colspan="6" class="muted">Aucune vente.</td></tr>';
        }else{
          salesTbody.innerHTML='';
          for(const s of salesRows){
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>${s.created_at?new Date(s.created_at).toLocaleString():''}</td>
              <td><b>${s.order_id||'-'}</b></td>
              <td>${s.institute_name||'-'}</td>
              <td>${s.pro_name||'-'}</td>
              <td>${s.postal_code||'-'}</td>
              <td>${s.amount!=null?(Number(s.amount).toFixed(2)+' '+(s.currency||'')):'-'}</td>`;
            salesTbody.appendChild(tr);
          }
        }
        salesOffset = j.nextOffset ?? (salesOffset + (j.items?.length||0));
      }catch(e){ admMsg.textContent='Erreur chargement (ventes)'; console.error(e); }
    }

    salesExportBtn.addEventListener('click', ()=>{
      if(!salesRows.length){ showToast('Aucune donnée à exporter', false); return; }
      const head=['date','order_id','institut','professionnel','cp','montant','devise'];
      const lines=[head.join(';')];
      salesRows.forEach(s=>{
        const r=[ s.created_at?new Date(s.created_at).toLocaleString():'', s.order_id||'', s.institute_name||'', s.pro_name||'', s.postal_code||'', s.amount!=null?Number(s.amount).toFixed(2):'', s.currency||'' ].map(x=>`"${String(x).replace(/"/g,'""')}"`);
        lines.push(r.join(';'));
      });
      const csv = '\uFEFF' + lines.join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `export-ventes-${todayStr()}.csv`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    });

    // ====== BENEFICIAIRES ======
    const refsTbody=$('#refs_tbody');
    const refsRibSel=$('#refs_rib'), refsFrom=$('#refs_from'), refsTo=$('#refs_to'), refsQ=$('#refs_q');
    const refsExportBtn=$('#refs_export');
    const reloadRefsDebounced = debounce(()=> loadReferrers(true), 400);
    [refsRibSel,refsFrom,refsTo,refsQ].forEach(el=>{
      el.addEventListener(el.tagName==='SELECT'?'change':'input', reloadRefsDebounced);
    });

    let refsOffset=0, refsLimit=100, refsRows=[];

    async function loadReferrers(reset=true){
      try{
        if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
        if(reset){ refsOffset=0; refsRows=[]; refsTbody.innerHTML='<tr><td colspan="5" class="muted">Chargement…</td></tr>'; }

        const qs=new URLSearchParams({
          search: refsQ.value || admSearchEl.value.trim(),
          rib: refsRibSel.value,
          date_from: refsFrom.value || '',
          date_to: refsTo.value || '',
          limit: String(refsLimit),
          offset: String(refsOffset)
        }).toString();

        const r=await fetch(`/api/admin/list-referrers?${qs}`,{ headers:auth() });
        const j=await r.json();
        if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; }
        if(reset) refsTbody.innerHTML='';

        const batch=j.items||[];
        refsRows = reset ? batch : refsRows.concat(batch);

        if(refsRows.length===0){
          refsTbody.innerHTML='<tr><td colspan="5" class="muted">Aucun bénéficiaire.</td></tr>';
        }else{
          refsTbody.innerHTML='';
          for(const x of refsRows){
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td><b>${(x.first_name||'')+' '+(x.last_name||'')}</b></td>
              <td>${x.email||'-'}</td>
              <td>${x.code||'-'}</td>
              <td><span class="pill ${x.rib_status==='approved'?'ok':x.rib_status==='pending'?'warn':x.rib_status==='rejected'?'bad':''}">${x.rib_status||'missing'}</span></td>
              <td>${x.last_activity?new Date(x.last_activity).toLocaleString():'-'}</td>`;
            refsTbody.appendChild(tr);
          }
        }
        refsOffset = j.nextOffset ?? (refsOffset + (j.items?.length||0));
      }catch(e){ admMsg.textContent='Erreur chargement (bénéficiaires)'; console.error(e); }
    }

// Export Bénéficiaires — génération locale (BOM UTF-8 + ; + CRLF)
refsExportBtn.addEventListener('click', () => {
  try {
    if (!refsRows || !refsRows.length) {
      showToast('Aucune donnée à exporter', false);
      return;
    }
    
    // En-têtes lisibles pour Excel FR
    const head = ['Commercial', 'Email', 'Code', 'Statut RIB', 'Dernière activité'];
    const lines = [head.join(';')];

    // Lignes
    refsRows.forEach(x => {
      const commercial = `${(x.first_name || '')} ${(x.last_name || '')}`.trim();
      const email      = x.email || '';
      const code       = x.code || '';
      const rib        = x.rib_status || 'missing';
      const last       = x.last_activity ? new Date(x.last_activity).toLocaleString() : '';

      const row = [commercial, email, code, rib, last]
        .map(v => `"${String(v).replace(/"/g, '""')}"`)
        .join(';');

      lines.push(row);
    });

    // BOM + CRLF pour forcer la bonne mise en colonnes
    const csv  = '\uFEFF' + lines.join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `export-beneficiaires-${todayStr()}.csv`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();

    showToast('Export bénéficiaires OK', true);
  } catch (e) {
    console.error(e);
    showToast('Export bénéficiaires impossible', false);
  }
});

    // ====== Charge TOUT en parallèle ======
    function loadAll(reset){
      loadCommissions(reset);
      loadRibs(reset);
      loadSales(reset);
      loadReferrers(reset);
    }

    // Auto au démarrage : si token présent, on charge tous les onglets
    document.addEventListener('DOMContentLoaded', ()=>{
      if(token()) loadAll(true);
    });
  </script>
</body>
</html>
