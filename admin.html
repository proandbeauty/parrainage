<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro&Beauty — Admin Commissions</title>
  <style>
    body{margin:0;background:#0b0f14;color:#eaf2fb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px}
    .card{background:#121821;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:6px 0 14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input,select{background:#0f141c;border:1px solid rgba(255,255,255,.12);color:#eaf2fb;border-radius:10px;padding:10px}
    button{background:#5dd4a3;border:none;color:#06281c;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{background:#87e6be}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;vertical-align:top}
    th{color:#9fb0c3;text-align:left}
    .muted{color:#9fb0c3}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141c;border:1px solid rgba(255,255,255,.15);font-size:12px}
    .right{float:right}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin — Commissions</h1>
      <div class="row">
        <input id="token" type="password" placeholder="ADMIN_TOKEN" style="min-width:260px" />
        <select id="status">
          <option value="all">Tous les statuts</option>
          <option value="pending">En attente</option>
          <option value="approved">Approuvé</option>
          <option value="paid">Payé</option>
        </select>
        <input id="search" type="text" placeholder="Recherche: nom, email, code, commande..." style="flex:1" />
        <button id="load">Charger</button>
        <button id="export">Exporter CSV</button>
      </div>
      <div id="msg" class="muted"></div>
      <table id="tab">
        <thead>
          <tr>
            <th>Commission</th>
            <th>Bénéficiaire</th>
            <th>Vente</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="4" class="muted">Cliquez sur “Charger”.</td></tr></tbody>
      </table>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="more">Charger +</button>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const msg = document.getElementById('msg');
    const tokenEl = document.getElementById('token');
    const statusEl = document.getElementById('status');
    const searchEl = document.getElementById('search');

    // ---- Nouvel état pagination (compatible page/limit OU offset) ----
    let page = 1, limit = 50, hasMore = true;
    let offset = 0;              // pour compat avec anciens endpoints
    let lastBatch = [];

    // garde le token (local)
    tokenEl.value = localStorage.getItem('pnb_admin_token') || '';
    tokenEl.addEventListener('change', ()=> localStorage.setItem('pnb_admin_token', tokenEl.value.trim()));

    // ---- Normalise l'item (compatible "flat" OU "imbriqué") ----
    function normalize(item){
      // format "flat" (venant d'une vue v_commissions_detailed par ex.)
      if (!item.beneficiary && !item.sale) {
        return {
          id: item.commission_id || item.id,
          amount: item.commission_amount ?? item.amount,
          currency: item.commission_currency ?? item.currency,
          status: item.status,
          role: item.role,
          created_at: item.commission_created_at || item.created_at,
          beneficiary: {
            first_name: item.first_name,
            last_name: item.last_name,
            email: item.email,
            referral_code: item.referral_code
          },
          sale: {
            id: item.sale_id,
            order_id: item.order_id,
            amount: item.sale_amount,
            currency: item.sale_currency,
            created_at: item.sale_created_at
          }
        };
      }
      // format "imbriqué" (ton format d’origine)
      return {
        id: item.id,
        amount: item.amount,
        currency: item.currency,
        status: item.status,
        role: item.role,
        created_at: item.created_at,
        beneficiary: item.beneficiary || {},
        sale: item.sale || {}
      };
    }

    async function load(reset=true){
      try{
        const token = tokenEl.value.trim();
        if(!token){ msg.textContent='Saisissez d’abord le token admin.'; return; }

        if(reset){
          // reset des 2 modes de pagination
          page = 1; hasMore = true;
          offset = 0;
          tbody.innerHTML = '<tr><td colspan="4" class="muted">Chargement…</td></tr>';
        }

        // On essaye d'abord le mode "page/limit" (nouvelle API)
        const base = '/api/admin/list-commissions';
        const q = new URLSearchParams({
          status: statusEl.value,
          search: searchEl.value.trim(),
          page: String(page),
          limit: String(limit)
        }).toString();

        let r = await fetch(`${base}?${q}`, {
          headers:{ Authorization:'Bearer '+token }
        });

        // Si l’endpoint ne comprend pas page/limit, on retombe sur offset (ancien)
        if (r.status === 400 || r.status === 404 || r.status === 422) {
          const q2 = new URLSearchParams({
            status: statusEl.value,
            search: searchEl.value.trim(),
            limit: String(limit),
            offset: String(offset)
          }).toString();
          r = await fetch(`${base}?${q2}`, { headers:{ Authorization:'Bearer '+token } });
        }

        const j = await r.json();
        if(!r.ok){ msg.textContent = j.error || 'Erreur'; return; }
        msg.textContent = '';

        // On récupère les items, en supportant j.items ou j.rows
        const items = Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
        lastBatch = items.map(normalize);

        // si reset, on efface le tableau avant d’ajouter
        if(reset) tbody.innerHTML = '';

        if(lastBatch.length===0 && (page===1 || offset===0)){
          tbody.innerHTML = '<tr><td colspan="4" class="muted">Aucune commission.</td></tr>';
        } else {
          for(const c of lastBatch){
            const b = c.beneficiary || {};
            const s = c.sale || {};
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div><b>${Number(c.amount).toFixed(2)} ${c.currency || ''}</b>
                  <span class="pill">${c.status}</span> <span class="pill">${c.role}</span></div>
                <div class="muted">${c.created_at ? new Date(c.created_at).toLocaleString() : ''}</div>
                <div class="muted">ID: ${c.id || ''}</div>
              </td>
              <td>
                <div><b>${(b.first_name||'')+' '+(b.last_name||'')}</b></div>
                <div class="muted">${b.email || ''}</div>
                <div class="muted">Code: ${b.referral_code || ''}</div>
              </td>
              <td>
                <div>Commande: <b>${s.order_id || '-'}</b></div>
                <div class="muted">Vente: ${s.id || ''}</div>
                <div class="muted">Montant: ${s.amount!=null ? Number(s.amount).toFixed(2)+' '+(s.currency||'') : '-'}</div>
                <div class="muted">${s.created_at ? new Date(s.created_at).toLocaleString() : ''}</div>
              </td>
              <td>
                <button data-id="${c.id}" data-to="approved">Approuver</button>
                <button data-id="${c.id}" data-to="paid">Marquer payé</button>
              </td>
            `;
            tbody.appendChild(tr);
          }
        }

        // mise à jour pagination
        if (typeof j.hasMore === 'boolean') {
          hasMore = j.hasMore;
          if (hasMore) page += 1;
        } else {
          // fallback offset
          offset = j.nextOffset != null ? j.nextOffset : (offset + lastBatch.length);
          hasMore = lastBatch.length === limit; // approx
          if (!hasMore) page += 1; // ne bloque pas le bouton si l’API repasse ensuite en page
        }

        // état du bouton "Charger +"
        const moreBtn = document.getElementById('more');
        moreBtn.disabled = !hasMore;
        moreBtn.textContent = hasMore ? 'Charger +' : 'Plus de résultats';

      }catch(e){
        msg.textContent='Erreur chargement';
        console.error(e);
      }
    }

    async function changeStatus(id, to){
      try{
        const r = await fetch('/api/admin/set-commission-status', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            Authorization:'Bearer '+tokenEl.value.trim()
          },
          body: JSON.stringify({ commission_id:id, status:to })
        });
        const j = await r.json();
        if(!r.ok){ alert(j.error || 'Erreur'); return; }
        await load(true);
      }catch(e){ alert('Erreur'); console.error(e); }
    }

    document.getElementById('load').onclick = ()=> load(true);
    document.getElementById('more').onclick = ()=> {
      if (!hasMore) return;
      load(false);
    };

    // --- Export CSV : on télécharge réellement le fichier (avec le token) ---
    document.getElementById('export').onclick = async ()=>{
      try{
        const token = tokenEl.value.trim();
        if(!token){ alert('Saisissez d’abord le token admin.'); return; }
        const url = `/api/admin/export-commissions?status=${encodeURIComponent(statusEl.value)}&search=${encodeURIComponent(searchEl.value.trim())}`;
        const res = await fetch(url, { headers:{ Authorization:'Bearer '+token } });
        if(!res.ok){
          const t = await res.text();
          alert('Export impossible : '+t);
          return;
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `export-commissions-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }catch(e){
        console.error(e);
        alert('Erreur export CSV.');
      }
    };

    // delegation boutons actions
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-id]');
      if(!btn) return;
      changeStatus(btn.dataset.id, btn.dataset.to);
    });
  </script>
</body>
</html>
