<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro&Beauty ‚Äî Admin (Commissions & RIB)</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --text:#eaf2fb; --muted:#9fb0c3;
      --stroke:rgba(255,255,255,.12); --divider:rgba(255,255,255,.08);
      --accent:#5dd4a3; --accent-2:#87e6be; --red:#ff6b6b;
      --green:#38d39f; --amber:#ffd166;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:30px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:18px;margin-bottom:14px}
    h1,h2{margin:6px 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input,select,button{font:inherit}
    input,select{background:#0f141c;border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:10px}
    button{background:var(--accent);border:none;color:#06281c;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer;transition:opacity .15s}
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#0f141c;border:1px solid var(--stroke);color:#eaf2fb}
    .btn-red{background:var(--red);color:#1b0b0b}
    .btn-red:hover{filter:brightness(1.05)}
    .btn-done{background:#0f141c;border:1px solid var(--divider);color:#9fb0c3;cursor:default}
    .btn-done:hover{background:#0f141c}

    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid var(--divider);padding:8px;vertical-align:top}
    th{color:#9fb0c3;text-align:left}
    .muted{color:#9fb0c3}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141c;border:1px solid rgba(255,255,255,.15);font-size:12px}
    .pill.ok{border-color:rgba(93,212,163,.6);color:#9bf0cf}
    .pill.warn{border-color:rgba(255,209,102,.6);color:#ffe6ad}
    .pill.bad{border-color:rgba(255,107,107,.6);color:#ffb3b3}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{background:#0f141c;border:1px solid var(--stroke);color:#eaf2fb;padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab.active{background:var(--accent);color:#06281c;border-color:transparent;font-weight:800}
    .hide{display:none !important}

    tr.flash-ok{animation: flashok 1.4s ease-out}
    tr.flash-bad{animation: flashbad 1.4s ease-out}
    @keyframes flashok { 0%{background:rgba(56,211,159,.25)} 100%{background:transparent} }
    @keyframes flashbad { 0%{background:rgba(255,107,107,.25)} 100%{background:transparent} }

    .toastbox{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{
      background:#0f141c;border:1px solid var(--divider);color:#eaf2fb;
      padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:flex;align-items:center;gap:8px;min-width:220px
    }
    .toast.ok .dot,.toast.bad .dot{width:10px;height:10px;border-radius:50%}
    .toast.ok .dot{background:var(--green)}
    .toast.bad .dot{background:var(--red)}
    .toast .label{font-weight:700}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
    .modal.show{display:flex}
    .modal .scrim{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .modal .panel{position:relative;background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:16px;min-width:320px;max-width:92vw}
    .modal h3{margin:0 0 10px}
    .modal .row{margin-bottom:8px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .field{display:flex;flex-direction:column;gap:6px;min-width:260px}
    .error{color:#ffb3b3;font-size:12px;min-height:16px}
    .invalid{border-color:#ff6b6b}

    /* === UI ajout√© === */

/* 1) Ent√™tes collantes + conteneurs scrollables */
.table-scroll{
  overflow:auto;
  border:1px solid var(--divider);
  border-radius:12px;
}
.table-scroll thead th{
  position:sticky;
  top:0;
  background:var(--card);
  z-index:2;
}

/* 2) Scrollbars modernes & discr√®tes */
*{
  scrollbar-width: thin;                /* Firefox */
  scrollbar-color: rgba(255,255,255,.18) transparent;
}
.table-scroll::-webkit-scrollbar{       /* Chrome/Edge/Safari */
  width:10px; height:10px;
}
.table-scroll::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.12));
  border-radius:12px;
  border:2px solid transparent;
  background-clip: padding-box;
}
.table-scroll::-webkit-scrollbar-track{
  background:transparent;
}

/* 3) Masquer les indicateurs Page/Offset */
#comm_hint, #rib_hint { display:none !important; }

/* 4) Petit bouton ‚Äú≈ìil‚Äù */
.btn-icon{
  background:#0f141c;
  border:1px solid var(--stroke);
  color:#eaf2fb;
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
}
/* Masque les boutons Export par onglet (on garde la logique JS) */
#comm_export, #rib_export, #sales_export, #refs_export { display: none !important; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin ‚Äî Pro&Beauty</h1>

      <div class="row" style="align-items:center">
        <input id="adm_token" type="password" placeholder="ADMIN_TOKEN (obligatoire)" style="min-width:260px" />
        <button id="toggle_token" class="btn-icon" title="Afficher / masquer le token">üëÅ</button>
      
        <input id="adm_search" type="text" placeholder="Recherche globale (nom, email, code, commande, IBAN‚Ä¶)" style="flex:1" />
      
        <button id="adm_reload" class="btn-ghost">Recharger</button>
        <!-- Bouton Export fixe et unique -->
        <button id="export_fixed" class="btn-ghost" title="Exporter les donn√©es de l‚Äôonglet actif">Exporter CSV</button>
      </div>
      <div id="adm_msg" class="muted" style="margin-bottom:8px"></div>

      <div class="tabs">
        <button class="tab active" data-tab="tab_comm">Commissions</button>
        <button class="tab" data-tab="tab_rib">RIB</button>
        <button class="tab" data-tab="tab_sales">Ventes / Clients</button>
        <button class="tab" data-tab="tab_refs">B√©n√©ficiaires</button>
      </div>

      <!-- === COMMISSIONS === -->
      <section id="tab_comm">
        <div class="row">
          <select id="comm_status">
            <option value="all">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="approved">Approuv√©</option>
            <option value="paid">Pay√©</option>
          </select>
          <button id="comm_export" class="btn-ghost">Exporter CSV</button>
          <div class="muted" id="comm_hint"></div>
        </div>
        <div id="comm_totals" class="muted" style="margin:6px 0 8px"></div>

        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Commission</th>
                <th>B√©n√©ficiaire</th>
                <th>Vente</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="comm_tbody"><tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="comm_more">Charger +</button>
        </div>
      </section>

      <!-- === RIB === -->
      <section id="tab_rib" class="hide">
        <div class="row">
          <select id="rib_status">
            <option value="all">Tous</option>
            <option value="pending">En attente</option>
            <option value="approved">Valid√©</option>
            <option value="rejected">Rejet√©</option>
          </select>
          <button id="rib_export" class="btn-ghost">Exporter CSV</button>
          <div class="muted" id="rib_hint"></div>
        </div>

        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th data-sort="created_at" style="cursor:pointer">RIB ‚ñ≤‚ñº</th>
                <th data-sort="referrer">Titulaire</th>
                <th data-sort="holder_name" style="cursor:pointer">IBAN (titulaire) ‚ñ≤‚ñº</th>
                <th>Justificatif</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rib_tbody"><tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="rib_more">Charger +</button>
        </div>
      </section>

      <!-- === VENTES === -->
      <section id="tab_sales" class="hide">
        <div class="row">
          <input id="sales_from" type="date" />
          <input id="sales_to" type="date" />
          <button id="sales_export" class="btn-ghost">Exporter CSV</button>
          <button id="sales_add" class="btn-ghost">Ajouter une vente</button>
        </div>

        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>N¬∞ commande</th>
                <th>Institut</th>
                <th>Professionnel</th>
                <th>Code postal</th>                
              </tr>
            </thead>
            <tbody id="sales_tbody"><tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- === BENEFICIAIRES === -->
      <section id="tab_refs" class="hide">
        <div class="row">
          <select id="refs_rib">
            <option value="all">RIB: Tous</option>
            <option value="approved">RIB valid√©</option>
            <option value="pending">RIB en attente</option>
            <option value="rejected">RIB rejet√©</option>
            <option value="missing">RIB manquant</option>
          </select>
          <input id="refs_from" type="date" />
          <input id="refs_to" type="date" />
          <!-- (BARRE SUPPRIM√âE) : la recherche se fait avec #adm_search -->
          <button id="refs_export" class="btn-ghost">Exporter CSV</button>
        </div>

        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Commercial</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <th>Marque</th>
                <th>Code</th>
                <th>R√¥le</th>
                <th>Code parrain</th>
                <th>Statut RIB</th>
                <th>Derni√®re activit√©</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="refs_tbody"><tr><td colspan="10" class="muted">Chargement‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <div class="toastbox" id="toastbox"></div>

  <!-- Modal: √©diter b√©n√©ficiaire -->
  <div id="modal-edit-ref" class="modal" aria-hidden="true">
    <div class="scrim" data-close="#modal-edit-ref"></div>
    <div class="panel">
      <h3>Modifier le b√©n√©ficiaire</h3>
      <form id="form-edit-ref">
        <div class="muted" style="color:#ff6b6b" data-err="form"></div>

        <input type="hidden" name="id" />
        <div class="row field">
          <input name="first_name" placeholder="Pr√©nom" required />
          <small class="error" data-err="first_name"></small>
        </div>
        <div class="row field">
          <input name="last_name" placeholder="Nom" required />
          <small class="error" data-err="last_name"></small>
        </div>
        <div class="row field">
          <input name="email" type="email" placeholder="Email" required />
          <small class="error" data-err="email"></small>
        </div>
        <div class="row field">
          <input name="phone" placeholder="T√©l√©phone" />
          <small class="error" data-err="phone"></small>
        </div>
        <div class="row field">
          <input name="brand" placeholder="Marque" />
          <small class="error" data-err="brand"></small>
        </div>
        <div class="row field">
          <input name="code" placeholder="Code parrain" readonly title="Le code ne peut pas √™tre modifi√© depuis l‚Äôadmin">
          <small class="error" data-err="code"></small>
        </div>
        <div class="actions">
          <button type="button" class="btn-ghost" data-close="#modal-edit-ref">Annuler</button>
          <button type="submit" class="btn-ghost">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: ajouter une vente / client -->
  <div id="modal-add-sale" class="modal" aria-hidden="true">
    <div class="scrim" data-close="#modal-add-sale"></div>
    <div class="panel">
      <h3>Ajouter une vente / client</h3>
      <form id="form-add-sale" novalidate>
        <div class="row field">
          <input name="order_id" placeholder="N¬∞ commande (optionnel)" />
          <small class="error" data-err="order_id"></small>
        </div>
        <div class="row field">
          <input name="institute_name" placeholder="Nom de l'institut" required />
          <small class="error" data-err="institute_name"></small>
        </div>
        <div class="row field">
          <input name="pro_name" placeholder="Nom et pr√©nom du professionnel" required />
          <small class="error" data-err="pro_name"></small>
        </div>
        <div class="row field">
          <input name="postal_code" placeholder="Code postal (5 chiffres)" inputmode="numeric" maxlength="5" required />
          <small class="error" data-err="postal_code"></small>
        </div>
        <div class="row field">
          <input name="referral_code" placeholder="Code parrain" required />
          <small class="error" data-err="referral_code"></small>
        </div>
        <div class="actions">
          <button type="button" class="btn-ghost" data-close="#modal-add-sale">Annuler</button>
          <button type="submit" class="btn-ghost">Cr√©er</button>
        </div>
        <div class="error" data-err="form"></div>
      </form>
    </div>
  </div>

  <script>
    console.log('[ADMIN] Script charg√©');
    window.addEventListener('error',e=>console.error('[ADMIN] JS error:',e.message));
    window.addEventListener('unhandledrejection',e=>console.error('[ADMIN] Promise rejection:',e.reason));

    const $ = q => document.querySelector(q);
    const debounce = (fn, ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function showToast(text, ok=true){
      const box = $('#toastbox');
      const div = document.createElement('div');
      div.className = 'toast ' + (ok ? 'ok' : 'bad');
      div.innerHTML = '<span class="dot"></span><span class="label">'+text+'</span>';
      box.appendChild(div);
      setTimeout(()=>{ div.style.opacity=.9 },10);
      setTimeout(()=>{ div.style.opacity=0; div.style.transform='translateY(-6px)'; }, 2200);
      setTimeout(()=>{ div.remove(); }, 2600);
    }
    function todayStr(){ return new Date().toISOString().slice(0,10); }
    function token(){ return ($('#adm_token').value || '').trim(); }
    function auth(){ return { 'x-admin-token': token() }; }

    function setPill(el, status){
      el.textContent = status;
      el.classList.remove('ok','warn','bad');
      if (status==='approved' || status==='paid' || status==='valid√©') el.classList.add('ok');
      else if (status==='pending' || status==='en attente') el.classList.add('warn');
      else if (status==='rejected') el.classList.add('bad');
    }

    async function downloadCsvFrom(url, filename) {
      try{
        const res = await fetch(url, { headers: auth() });
        if (!res.ok) { showToast('Export impossible', false); return; }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      }catch(_){ showToast('Export impossible', false); }
    }

    function openModal(sel){ const m=document.querySelector(sel); if(m){ m.classList.add('show'); } }
    function closeModal(sel){ const m=document.querySelector(sel); if(m){ m.classList.remove('show'); } }
    document.addEventListener('click',(e)=>{
      const t=e.target.closest('[data-close]'); if(!t) return;
      e.preventDefault(); closeModal(t.getAttribute('data-close'));
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        document.querySelectorAll('.modal.show').forEach(m=> m.classList.remove('show'));
      }
    });

    const admTokenEl = $('#adm_token');
    const admSearchEl = $('#adm_search');
    const admMsg = $('#adm_msg');
    const tabs = document.querySelectorAll('.tab');

    // --- zone scrollable : ajuste √† la fen√™tre
    function resizeScrollers(){
      document.querySelectorAll('.table-scroll').forEach(div=>{
        const top = div.getBoundingClientRect().top;
        const h = window.innerHeight - top - 24;
        div.style.maxHeight = h + 'px';
      });
    }
    window.addEventListener('resize', resizeScrollers);
    window.addEventListener('load', resizeScrollers);

    // --- m√©morisation token
    admTokenEl.value = localStorage.getItem('pnb_admin_token') || '';
    admTokenEl.addEventListener('input', ()=> localStorage.setItem('pnb_admin_token', admTokenEl.value.trim()));

    // --- gestion onglets
    let currentTab = 'tab_comm';
    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('section[id^="tab_"]').forEach(s=>s.classList.add('hide'));
        currentTab = btn.dataset.tab;
        document.getElementById(currentTab).classList.remove('hide');
        resizeScrollers();
        // recalcul totaux si commissions
        if (currentTab === 'tab_comm') refreshCommissionTotals();
      });
    });

    // --- recharger
    $('#adm_reload')?.addEventListener('click', ()=>{ loadAll(true); refreshCommissionTotals(); });

    // --- recherche globale : met √† jour l'onglet ACTIF en live
    admSearchEl.addEventListener('input', debounce(()=>{
      if (currentTab === 'tab_comm') { loadCommissions(true); refreshCommissionTotals(); }
      else if (currentTab === 'tab_rib') { loadRibs(true); }
      else if (currentTab === 'tab_sales') { loadSales(true); }
      else if (currentTab === 'tab_refs') { loadReferrers(true); }
    }, 400));

    admTokenEl.addEventListener('input', debounce(()=> loadAll(true), 300));

    // ===================== COMMISSIONS =====================
    const commTbody = $('#comm_tbody');
    const commStatusEl = $('#comm_status');
    const commMoreBtn = $('#comm_more');
    const commHint = $('#comm_hint');
    let commPage=1, commLimit=50, commHasMore=true, commOffset=0, commLastBatch=[];

    commStatusEl.addEventListener('change', ()=> { loadCommissions(true); refreshCommissionTotals(); });

    function commNormalize(item){
      if (!item.beneficiary && !item.sale) {
        return {
          id: item.commission_id || item.id,
          amount: item.commission_amount ?? item.amount,
          currency: item.commission_currency ?? item.currency,
          status: item.status,
          role: item.role,
          created_at: item.commission_created_at || item.created_at,
          beneficiary: { first_name:item.first_name, last_name:item.last_name, email:item.email, referral_code:item.referral_code },
          sale: { id:item.sale_id, order_id:item.order_id, amount:item.sale_amount, currency:item.sale_currency, created_at:item.sale_created_at }
        };
      }
      return item;
    }

    async function loadCommissions(reset=true){
      try{
        if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
        if(reset){ commPage=1; commHasMore=true; commOffset=0; commTbody.innerHTML='<tr><td colspan="4" class="muted">Chargement‚Ä¶</td></tr>'; }

        const base='/api/admin/list-commissions';
        const p={ search:admSearchEl.value.trim(), page:String(commPage), limit:String(commLimit) };
        if(commStatusEl.value!=='all') p.status=commStatusEl.value;
        let url=`${base}?${new URLSearchParams(p).toString()}`;
        let r=await fetch(url,{ headers:auth() });

        if(r.status===400||r.status===404||r.status===422){
          const p2={ search:admSearchEl.value.trim(), limit:String(commLimit), offset:String(commOffset) };
          if(commStatusEl.value!=='all') p2.status=commStatusEl.value;
          url=`${base}?${new URLSearchParams(p2).toString()}`;
          r=await fetch(url,{ headers:auth() });
        }

        const j=await r.json();
        if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; }
        admMsg.textContent='';

        const items=Array.isArray(j.items)?j.items:(Array.isArray(j.rows)?j.rows:[]);
        commLastBatch=items.map(commNormalize);
        // D√©dupliquer par (sale_id|order_id, role) pour √©viter les clones visuels
const seen = new Set();
commLastBatch = commLastBatch.filter(c => {
  const s = c.sale || {};
  const key = `${c.role}|${s.id || s.order_id || c.id}`;
  if (seen.has(key)) return false;
  seen.add(key);
  return true;
});
        if(reset) commTbody.innerHTML='';

        if(commLastBatch.length===0 && (commPage===1||commOffset===0)){
          commTbody.innerHTML='<tr><td colspan="4" class="muted">Aucune commission.</td></tr>';
        }else{
          for(const c of commLastBatch){
            const b = c.beneficiary || {};
            const s = c.sale || {};
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>
                <div><b>${Number(c.amount).toFixed(2)} ${c.currency||''}</b>
                  <span class="pill ${c.status==='paid'?'ok':c.status==='approved'?'ok':c.status==='pending'?'warn':''}" data-pill="status">${c.status}</span>
                  <span class="pill">${c.role}</span>
                </div>
                <div class="muted">${c.created_at?new Date(c.created_at).toLocaleString():''}</div>
                <div class="muted">ID: ${c.id||''}</div>
              </td>
              <td>
                <div><b>${(b.first_name||'')+' '+(b.last_name||'')}</b></div>
                <div class="muted">${b.email||''}</div>
                <div class="muted">Code: ${b.referral_code||''}</div>
              </td>
              <td>
                <div>Commande: <b>${s.order_id||'-'}</b></div>
                <div class="muted">${s.created_at?new Date(s.created_at).toLocaleString():''}</div>
              </td>
              <td>
                ${c.status==='approved'||c.status==='paid'
                  ? '<button class="btn-done" disabled>Approuv√© ‚úì</button>'
                  : `<button class="btn-ghost" data-comm="approved" data-id="${c.id}">Approuver</button>`}
                ${c.status==='paid'
                  ? '<button class="btn-done" disabled>Pay√© ‚úì</button>'
                  : `<button class="btn-red" data-comm="paid" data-id="${c.id}">Marquer pay√©</button>`}
              </td>`;
            commTbody.appendChild(tr);
          }
        }

        if(typeof j.hasMore==='boolean'){ commHasMore=j.hasMore; if(commHasMore) commPage+=1; }
        else{ commOffset=j.nextOffset!=null?j.nextOffset:(commOffset+commLastBatch.length); commHasMore=commLastBatch.length===commLimit; if(!commHasMore) commPage+=1; }

        commMoreBtn.disabled=!commHasMore;
        commMoreBtn.textContent=commHasMore?'Charger +':'Plus de r√©sultats';
        commHint.textContent=`Page ${commPage-1}`;
      }catch(e){ admMsg.textContent='Erreur chargement (commissions)'; console.error(e); }
    }

    function updateCommissionRowUI(btn, newStatus){
      const tr = btn.closest('tr');
      const pill = tr.querySelector('[data-pill="status"]');
      setPill(pill, newStatus);
      const [b1, b2] = tr.querySelectorAll('td:last-child button');
      if(newStatus === 'approved'){
        if(b1){ b1.textContent='Approuv√© ‚úì'; b1.className='btn-done'; b1.disabled=true; }
        tr.classList.add('flash-ok');
      }
      if(newStatus === 'paid'){
        if(b2){ b2.textContent='Pay√© ‚úì'; b2.className='btn-done'; b2.disabled=true; }
        if(b1){ b1.textContent='Approuv√© ‚úì'; b1.className='btn-done'; b1.disabled=true; }
        tr.classList.add('flash-ok');
      }
      setTimeout(()=> tr.classList.remove('flash-ok','flash-bad'),1500);
    }

    commTbody.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-comm]'); if(!btn) return;
      const id = btn.dataset.id, to = btn.dataset.comm;
      btn.disabled = true; btn.style.opacity = .7;
      fetch('/api/admin/set-commission-status',{method:'POST',headers:{'Content-Type':'application/json',...auth()},body:JSON.stringify({commission_id:id,status:to})})
        .then(r=>r.json().then(j=>({ok:r.ok,j})))
        .then(({ok,j})=>{
          if(!ok){ btn.disabled=false; btn.style.opacity=1; showToast(j.error||'Erreur', false); return; }
          updateCommissionRowUI(btn, to);
          showToast(to==='approved'?'Commission approuv√©e ‚úÖ':'Commission marqu√©e pay√©e üí∏', true);
          refreshCommissionTotals();
        })
        .catch(()=>{ btn.disabled=false; btn.style.opacity=1; showToast('Erreur r√©seau', false); });
    });

    commMoreBtn.addEventListener('click', ()=>{ if(commHasMore) loadCommissions(false); });

    document.getElementById('comm_export').addEventListener('click', async ()=>{
      try{
        const p = { search: admSearchEl.value.trim(), ...(commStatusEl.value!=='all' ? { status: commStatusEl.value } : {}) };
        const url = `/api/admin/export-commissions?${new URLSearchParams(p).toString()}`;
        const res = await fetch(url, { headers: auth() });
        if (res.ok) {
          const blob = await res.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `export-commissions-${todayStr()}.csv`;
          document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
          return;
        }
      } catch (_) {}
      try {
        const rows = await fetchAllCommissionsForExport();
        if (!rows.length) { showToast('Aucune commission √† exporter', false); return; }
        const head = ['date','commission_id','status','role','amount','currency','beneficiary_name','beneficiary_email','referral_code','order_id','sale_amount','sale_currency','sale_date'];
        const lines = [head.join(';')];
        for (const c of rows) {
          const b = c.beneficiary || {}; const s = c.sale || {};
          const vals = [
            c.created_at ? new Date(c.created_at).toLocaleString() : '',
            c.id || '', c.status || '', c.role || '',
            (c.amount!=null ? Number(c.amount).toFixed(2) : ''), (c.currency || ''),
            `${(b.first_name||'')+' '+(b.last_name||'')}`.trim(), (b.email||''), (b.referral_code||''),
            (s.order_id||''), (s.amount!=null ? Number(s.amount).toFixed(2) : ''), (s.currency||''),
            s.created_at ? new Date(s.created_at).toLocaleString() : ''
          ].map(x => '"'+String(x).replace(/"/g,'""')+'"');
          lines.push(vals.join(';'));
        }
        const csv = '\uFEFF' + lines.join('\r\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `export-commissions-${todayStr()}.csv`;
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      } catch (e) { console.error(e); showToast('Export impossible', false); }
    });

    async function fetchAllCommissionsForExport() {
      const out = [];
      const base = { search: admSearchEl.value.trim() };
      if (commStatusEl && commStatusEl.value !== 'all') base.status = commStatusEl.value;

      let page = 1, limit = 200, keep = true;
      while (keep && page <= 500) {
        const p = { ...base, page: String(page), limit: String(limit) };
        const r = await fetch(`/api/admin/list-commissions?${new URLSearchParams(p).toString()}`, { headers: auth() });
        if (r.status === 400 || r.status === 404 || r.status === 422) { keep = false; break; }
        const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Erreur liste commissions');
        const batch = Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
        out.push(...batch.map(commNormalize));
        if (j.hasMore === false || batch.length < limit) break;
        page++;
      }
      if (out.length) return out;

      let offset = 0; keep = true;
      while (keep && offset <= 20000) {
        const p = { ...base, offset: String(offset), limit: '500' };
        const r = await fetch(`/api/admin/list-commissions?${new URLSearchParams(p).toString()}`, { headers: auth() });
        const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Erreur liste commissions (offset)');
        const batch = Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
        out.push(...batch.map(commNormalize));
        if (!batch.length) break;
        offset = j.nextOffset != null ? j.nextOffset : (offset + batch.length);
      }
      return out;
    }

    // ====== Totaux Commissions ======
    const commTotalsEl = document.getElementById('comm_totals');
    function fmtMoney(amount, currency='EUR'){
      const n = Number(amount || 0);
      try{ return new Intl.NumberFormat('fr-FR',{style:'currency',currency}).format(n); }
      catch{ return `${n.toFixed(2)} ${currency}`; }
    }
    async function refreshCommissionTotals(){
      if (!commTotalsEl) return;
      if (!token()) { commTotalsEl.textContent=''; return; }
      commTotalsEl.textContent = 'Calcul des totaux‚Ä¶';
      try{
        const rows = await fetchAllCommissionsForExport();
        // D√©dupliquer aussi les totaux
const seenKeys = new Set();
const uniqRows = [];
for (const c0 of rows) {
  const c = c0.beneficiary || c0.sale ? c0 : { amount:c0.commission_amount ?? c0.amount, currency:c0.commission_currency ?? c0.currency, status:c0.status, role:c0.role, sale:{ id:c0.sale_id, order_id:c0.order_id } };
  const s = c.sale || {};
  const key = `${c.role}|${s.id || s.order_id || c.id}`;
  if (!seenKeys.has(key)) { seenKeys.add(key); uniqRows.push(c0); }
}
// et ensuite, parcourez uniqRows au lieu de rows
const source = uniqRows;
        const totals = {
          pending:{count:0,sum:0}, approved:{count:0,sum:0}, paid:{count:0,sum:0}, other:{count:0,sum:0}, all:{count:0,sum:0}
        };
        const currencies = new Set();
        for (const c0 of rows){
          const c = c0.beneficiary || c0.sale ? c0 : { amount:c0.commission_amount ?? c0.amount, currency:c0.commission_currency ?? c0.currency, status:c0.status };
          const cur=c.currency||'EUR'; currencies.add(cur);
          const amt=Number(c.amount||0);
          totals.all.count++; totals.all.sum+=amt;
          const key=(c.status==='pending'||c.status==='approved'||c.status==='paid')?c.status:'other';
          totals[key].count++; totals[key].sum+=amt;
        }
        const currency = currencies.size===1 ? [...currencies][0] : 'EUR';
        const mixed = currencies.size>1;
        commTotalsEl.innerHTML = rows.length===0
          ? 'Aucune commission pour le filtre en cours.'
          : [
              `<b>Totaux filtr√©s</b> : ${totals.all.count} commissions`,
              `‚Ä¢ <b>En attente</b> : ${totals.pending.count} (${fmtMoney(totals.pending.sum, currency)})`,
              `‚Ä¢ <b>Approuv√©es</b> : ${totals.approved.count} (${fmtMoney(totals.approved.sum, currency)})`,
              `‚Ä¢ <b>Pay√©es</b> : ${totals.paid.count} (${fmtMoney(totals.paid.sum, currency)})`,
              `‚Ä¢ <b>Total</b> : ${fmtMoney(totals.all.sum, currency)}`
            ].join('   |   ') + (mixed ? ' <span class="pill warn">Devises mixtes</span>' : '');
      }catch(err){
        console.error('refreshCommissionTotals error:', err);
        commTotalsEl.textContent = 'Impossible de calculer les totaux.';
      }
    }

    // ===================== RIB =====================
    const ribTbody=$('#rib_tbody'), ribStatusEl=$('#rib_status'), ribMoreBtn=$('#rib_more'), ribExportBtn=$('#rib_export'), ribHint=$('#rib_hint');
    let ribOffset=0, ribLastBatch=[], ribSortBy='created_at', ribSortDir='desc';

    function maskIban(iban){ if(!iban) return ''; const c=String(iban).replace(/\s+/g,''); if(c.length<=8) return c; return c.slice(0,4)+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+c.slice(-4); }
    function refreshRibHeaders(){
      const thC=document.querySelector('th[data-sort="created_at"]'); const thH=document.querySelector('th[data-sort="holder_name"]');
      const up=' ‚ñ≤',down=' ‚ñº'; if(thC) thC.textContent='RIB'+(ribSortBy==='created_at'?(ribSortDir==='asc'?up:down):' ‚ñ≤‚ñº');
      if(thH) thH.textContent='IBAN (titulaire)'+(ribSortBy==='holder_name'?(ribSortDir==='asc'?up:down):' ‚ñ≤‚ñº');
    }
    ribStatusEl.addEventListener('change', ()=> loadRibs(true));

    async function loadRibs(reset=true){
  try{
    if(!token()){ admMsg.textContent='Saisissez le token admin.'; return; }
    if(reset){ ribOffset=0; ribTbody.innerHTML='<tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr>'; }

    // NEW: map tri "holder_name" -> "titulaire" si le backend ne conna√Æt pas holder_name
    const sortParam = (ribSortBy === 'holder_name') ? 'titulaire' : ribSortBy;

    const url=`/api/admin/ribs-list?status=${encodeURIComponent(ribStatusEl.value)}&limit=50&offset=${ribOffset}&search=${encodeURIComponent(admSearchEl.value.trim())}&sort_by=${encodeURIComponent(sortParam)}&order=${encodeURIComponent(ribSortDir)}`;
    const r=await fetch(url,{ headers:auth() }); 
    const j=await r.json();
    if(!r.ok){ admMsg.textContent=j.error||'Erreur'; return; } 
    admMsg.textContent='';

    if(reset) ribTbody.innerHTML=''; 
    ribLastBatch=j.items||[];

    if(ribLastBatch.length===0 && ribOffset===0){ 
      ribTbody.innerHTML='<tr><td colspan="5" class="muted">Aucun RIB.</td></tr>'; 
    } else {
      for(const row of ribLastBatch){
        const ref=row.referrer||{};
        // NEW: accepter rib.titulaire/justificatif_path si holder_name/doc_path sont absents
        const holder = row.holder_name ?? row.titulaire ?? '';
        const proofPath = row.doc_path ?? row.justificatif_path ?? '';
        // NEW: d√©j√† pr√©vu pour iban_masked || iban
        const ibanMasked = row.iban_masked || row.iban || '';

        const pillClass = row.status==='approved'?'ok':row.status==='pending'?'warn':row.status==='rejected'?'bad':'';
        const tr=document.createElement('tr');
        tr.innerHTML =
          '<td>'
            + '<div><b>'+ row.id +'</b> <span class="pill '+pillClass+'" data-pill="rib">'+ (row.status||'') +'</span></div>'
            + '<div class="muted">'+ (row.created_at?new Date(row.created_at).toLocaleString():'') +'</div>'
          + '</td>'
          + '<td><div><b>'+ holder +'</b></div><div class="muted">'+ (ref.email||'') +'</div><div class="muted">Code: '+ (ref.referral_code||'') +'</div></td>'
          + '<td><div><b>'+ maskIban(ibanMasked) +'</b></div><div class="muted">'+ (row.bic?('BIC: '+row.bic):'') +'</div><div class="muted">'+ (holder?('Titulaire: '+holder):'') +'</div></td>'
          + '<td>'+ (proofPath?('<button class="btn-ghost" data-proof="'+row.id+'">Voir justificatif</button>'):'<span class="muted">‚Äî</span>') +'</td>'
          + '<td>'
              + (row.status==='approved' ? '<button class="btn-done" disabled>Valid√© ‚úì</button>' : '<button class="btn-ghost" data-rib="approved" data-id="'+row.id+'">Valider</button>')
              + ' '
              + (row.status==='rejected' ? '<button class="btn-done" disabled>Rejet√© ‚úì</button>' : '<button class="btn-red" data-rib="rejected" data-id="'+row.id+'">Rejeter</button>')
          + '</td>';
        ribTbody.appendChild(tr);
      }
    }
    ribOffset=j.nextOffset ?? (ribOffset+ribLastBatch.length);
    refreshRibHeaders(); 
    ribHint.textContent=`Offset ${ribOffset}`;
  }catch(e){ 
    admMsg.textContent='Erreur chargement (RIB)'; 
    console.error(e); 
  }
}

    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col=th.getAttribute('data-sort'); if(col==='referrer') return;
        if(ribSortBy===col) ribSortDir=(ribSortDir==='asc'?'desc':'asc'); else { ribSortBy=col; ribSortDir='asc'; }
        loadRibs(true);
      });
    });

    document.getElementById('toggle_token')?.addEventListener('click', ()=>{
  const el = document.getElementById('adm_token');
  el.type = (el.type === 'password') ? 'text' : 'password';
});

    ribTbody.addEventListener('click', (e)=>{
      const p=e.target.closest('button[data-proof]'); if(p){ openProof(p.dataset.proof); return; }
      const b=e.target.closest('button[data-rib]'); if(!b) return;
      const id=b.dataset.id, to=b.dataset.rib;
      b.disabled=true; b.style.opacity=.7;
      fetch('/api/admin/ribs-set-status',{method:'POST',headers:{'Content-Type':'application/json',...auth()},body:JSON.stringify({id,status:to,note:''})})
        .then(r=>r.json().then(j=>({ok:r.ok,j})))
        .then(({ok,j})=>{
          if(!ok){ b.disabled=false; b.style.opacity=1; showToast(j.error||'Erreur', false); return; }
          const tr=b.closest('tr'); const pill=tr.querySelector('[data-pill="rib"]');
          setPill(pill,to);
          showToast(to==='approved'?'RIB valid√© ‚úÖ':'RIB rejet√© ‚ùå', to==='approved');
        })
        .catch(()=>{ b.disabled=false; b.style.opacity=1; showToast('Erreur r√©seau', false); });
    });

    async function openProof(rib_id){
      try{
        if (!token()) { alert('Saisissez le token admin.'); return; }
        const r = await fetch(`/api/admin/ribs-proof?id=${encodeURIComponent(rib_id)}`, { headers: auth() });
        const text = await r.text();
        let j = {}; try { j = text ? JSON.parse(text) : {}; } catch { j = { error: text || '' }; }
        if (!r.ok) { alert((j.error || `Erreur HTTP ${r.status}`) + (j.detail ? `\n${j.detail}` : '')); return; }
        if (!j.url) { alert('Lien justificatif manquant.'); return; }
        window.open(j.url, '_blank', 'noopener');
      }catch(e){ console.error('openProof error:', e); alert('Impossible d‚Äôouvrir le justificatif.'); }
    }

    ribMoreBtn.addEventListener('click', ()=> loadRibs(false));
    ribExportBtn.addEventListener('click', async ()=>{
      const p = { status: $('#rib_status').value, search: admSearchEl.value.trim(), sort_by:'created_at', order:'desc', limit:'10000', offset:'0', format:'csv' };
      const url = `/api/admin/ribs-list?${new URLSearchParams(p).toString()}`;
      await downloadCsvFrom(url, `export-ribs-${todayStr()}.csv`);
    });

    // ===================== VENTES =====================
    const salesTbody = $('#sales_tbody');
    const salesFrom = $('#sales_from');
    const salesTo = $('#sales_to');
    const salesCp = null;
    const salesAmtMin = null;
    const salesAmtMax = null;
    let salesOffset = 0;

    [salesFrom, salesTo].forEach(el => { if (el) el.addEventListener('input', debounce(() => loadSales(true), 400)); });

    async function loadSales(reset = true) {
      try {
        if (!token()) return;
        if (reset) { salesOffset = 0; salesTbody.innerHTML = '<tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr>'; }

        const p = { limit: '50', offset: String(salesOffset) };
        if (salesFrom.value) p.date_from = salesFrom.value;
        if (salesTo.value) p.date_to = salesTo.value;
    // filtres supprim√©s : rien √† faire ici

        if (admSearchEl.value.trim()) p.search = admSearchEl.value.trim();

        const r = await fetch(`/api/admin/list-sales?${new URLSearchParams(p).toString()}`, { headers: auth() });
        const j = await r.json();
        if (!r.ok) { admMsg.textContent = j.error || 'Erreur'; return; }

        if (reset) salesTbody.innerHTML = '';
        const items = j.items || [];
        if (items.length === 0 && salesOffset === 0) {
          salesTbody.innerHTML = '<tr><td colspan="5" class="muted">Aucune vente.</td></tr>';
        } else {
          for (const s of items) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${s.created_at ? new Date(s.created_at).toLocaleDateString() : ''}</td>
              <td>${s.order_id || '-'}</td>
              <td>${s.institute_name || ''}</td>
              <td>${s.pro_name || ''}</td>
              <td>${s.postal_code || ''}</td>`;
            salesTbody.appendChild(tr);
          }
        }
        salesOffset = j.nextOffset ?? (salesOffset + items.length);
      } catch (e) {
        console.error('loadSales error:', e);
        salesTbody.innerHTML = '<tr><td colspan="5" class="muted">Erreur chargement</td></tr>';
      }
    }

    $('#sales_add')?.addEventListener('click', () => {
  const form = $('#form-add-sale');
  if (form) {
    form.reset();
    document.querySelectorAll('#modal-add-sale [data-err]').forEach(el => el.textContent = '');
    openModal('#modal-add-sale');
  }
});

$('#form-add-sale')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const btn  = form.querySelector('button[type="submit"]');
  if (!token()) { showToast('Token admin requis', false); return; }

  // Nettoyage erreurs visuelles
  document.querySelectorAll('#modal-add-sale [data-err]').forEach(el => el.textContent = '');

  // Lecture + normalisation
  const fd   = new FormData(form);
  const data = Object.fromEntries([...fd.entries()].map(([k,v])=>[k,String(v).trim()]));

  // Validations l√©g√®res c√¥t√© UI
  const cpOk = /^\d{5}$/.test(data.postal_code || '');
  if (!cpOk) {
    document.querySelector('#modal-add-sale [data-err="postal_code"]').textContent = 'Code postal invalide (5 chiffres).';
    return;
  }
  if (!data.institute_name || !data.pro_name || !data.referral_code) {
    document.querySelector('#modal-add-sale [data-err="form"]').textContent = 'Tous les champs visibles sont requis.';
    return;
  }

  // Normalisation du code parrain
  const normRefCode = data.referral_code.replace(/\s+/g,' ').trim();

  // G√©n√®re un order_id si vide
  const autoOrderId = data.order_id
    ? data.order_id.trim()
    : `ORDER-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random()*1e6).toString().padStart(6,'0')}`;

// Payload ‚Äúcompat‚Äù : valeurs s√ªres pour satisfaire l‚ÄôAPI
const payload = {
  // champs visibles
  order_id: autoOrderId,
  institute_name: data.institute_name,
  pro_name: data.pro_name,
  postal_code: data.postal_code,

  // code vendeur : on envoie tous les alias possibles
  referral_code: normRefCode,
  code: normRefCode,
  seller_code: normRefCode,

  // champs souvent requis par la route
  buyer_email: `client+${Date.now()}@noreply.local`,
  amount: 1,               // ‚ö†Ô∏è mettre > 0 pour √©viter le refus ‚Äúmontant‚Äù
  currency: 'EUR',
  created_at: new Date().toISOString()
};

  btn.disabled = true;
  try {
    const res = await fetch('/api/admin/create-sale', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...auth() },
      body: JSON.stringify(payload)
    });

    // Lecture robuste de la r√©ponse
    const txt = await res.text();
let j = {};
try { j = txt ? JSON.parse(txt) : {}; } catch { j = { error: txt || '' }; }

if (!res.ok) {
  // Affiche le statut et le corps brut pour comprendre quel champ manque
  document.querySelector('#modal-add-sale [data-err="form"]').textContent =
    (j.error || 'Erreur serveur') + (txt && txt !== j.error ? ` ‚Äî ${txt}` : '');
  console.error('create-sale error', res.status, j, txt);
  return;
}

    closeModal('#modal-add-sale');
    showToast('Vente cr√©√©e ‚úÖ', true);
    loadSales(true);
  } catch (err) {
    console.error('create-sale network error:', err);
    document.querySelector('#modal-add-sale [data-err="form"]').textContent = 'Erreur r√©seau';
  } finally {
    btn.disabled = false;
  }
});

    document.getElementById('sales_export')?.addEventListener('click', async () => {
  try {
    const p = { limit:'10000', offset:'0' };
    if (salesFrom.value) p.date_from = salesFrom.value;
    if (salesTo.value)   p.date_to   = salesTo.value;
    if (admSearchEl.value.trim()) p.search = admSearchEl.value.trim();

    const r = await fetch(`/api/admin/list-sales?${new URLSearchParams(p).toString()}`, { headers: auth() });
    const j = await r.json();
    if (!r.ok) { showToast(j.error || 'Export impossible', false); return; }

    const rows = Array.isArray(j.items) ? j.items : [];
    if (!rows.length) { showToast('Aucune vente √† exporter', false); return; }

    const head = ['date','order_id','institut','professionnel','cp','montant','devise'];
    const lines = [head.join(';')];
    rows.forEach(s => {
      const line = [
        s.created_at ? new Date(s.created_at).toLocaleString() : '',
        s.order_id || '', s.institute_name || '', s.pro_name || '',
        s.postal_code || '', s.amount != null ? Number(s.amount).toFixed(2) : '', s.currency || 'EUR'
      ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(';');
      lines.push(line);
    });
    const csv = '\uFEFF' + lines.join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `export-ventes-${todayStr()}.csv`;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    showToast('Export ventes OK', true);
  } catch (e) { console.error(e); showToast('Export impossible', false); }
});

    // ===================== BENEFICIAIRES =====================
    const refsTbody = $('#refs_tbody');
    const refsRib = $('#refs_rib');
    const refsFrom = $('#refs_from');
    const refsTo = $('#refs_to');
    let refsOffset = 0;

    [refsRib, refsFrom, refsTo].forEach(el => { if (el) el.addEventListener('input', debounce(() => loadReferrers(true), 400)); });

    async function loadReferrers(reset = true) {
      try {
        if (!token()) return;
        if (reset) { refsOffset = 0; refsTbody.innerHTML = '<tr><td colspan="10" class="muted">Chargement‚Ä¶</td></tr>'; }

        const p = { limit: '100', offset: String(refsOffset) };
        if (refsRib.value !== 'all') p.rib = refsRib.value;
        if (refsFrom.value) p.date_from = refsFrom.value;
        if (refsTo.value) p.date_to = refsTo.value;
        if (admSearchEl.value.trim()) p.search = admSearchEl.value.trim();   // recherche globale

        const r = await fetch(`/api/admin/list-referrers?${new URLSearchParams(p).toString()}`, { headers: auth() });
        const j = await r.json();
        if (!r.ok) { admMsg.textContent = j.error || 'Erreur'; return; }

        if (reset) refsTbody.innerHTML = '';
        const items = j.items || [];
        if (items.length === 0 && refsOffset === 0) {
          refsTbody.innerHTML = '<tr><td colspan="10" class="muted">Aucun b√©n√©ficiaire.</td></tr>';
        } else {
          for (const ref of items) {
            const tr = document.createElement('tr');
            const ribPill = ref.rib_status==='approved'?'ok':ref.rib_status==='pending'?'warn':ref.rib_status==='rejected'?'bad':'';
            tr.innerHTML = `
              <td><b>${(ref.first_name || '') + ' ' + (ref.last_name || '')}</b></td>
              <td>${ref.email || ''}</td>
              <td>${ref.phone || '-'}</td>
              <td>${ref.brand || '-'}</td>
              <td><code>${ref.code || ''}</code></td>
              <td>${ref.role || '-'}</td>
              <td>${ref.role === 'filleul' ? (ref.parent_code || '-') : '-'}</td>
              <td><span class="pill ${ribPill}">${ref.rib_status || 'missing'}</span></td>
              <td class="muted">${ref.last_activity ? new Date(ref.last_activity).toLocaleDateString() : ''}</td>
              <td><button class="btn-ghost" data-edit-ref="${ref.id}">Modifier</button></td>`;
            refsTbody.appendChild(tr);
          }
        }
        refsOffset = j.nextOffset ?? (refsOffset + items.length);
      } catch (e) {
        console.error('loadReferrers error:', e);
        refsTbody.innerHTML = '<tr><td colspan="10" class="muted">Erreur chargement</td></tr>';
      }
    }

    refsTbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-edit-ref]'); if (!btn) return;
      const refId = btn.dataset.editRef; if (!refId) return;
      try {
        const r = await fetch(`/api/admin/list-referrers?id=${encodeURIComponent(refId)}&limit=1`, { headers: auth() });
        const j = await r.json();
        if (!r.ok || !j.items || !j.items.length) { showToast('Erreur lors du chargement du b√©n√©ficiaire', false); return; }
        const ref = j.items[0];
        const form = $('#form-edit-ref');
        form.querySelector('[name="id"]').value         = ref.id;
        form.querySelector('[name="first_name"]').value = ref.first_name || '';
        form.querySelector('[name="last_name"]').value  = ref.last_name  || '';
        form.querySelector('[name="email"]').value      = ref.email      || '';
        form.querySelector('[name="phone"]').value      = ref.phone      || '';
        form.querySelector('[name="brand"]').value      = ref.brand      || '';
        form.querySelector('[name="code"]').value       = ref.code || ref.referral_code || '';
        document.querySelectorAll('#modal-edit-ref [data-err]').forEach(el => el.textContent = '');
        openModal('#modal-edit-ref');
      } catch (err) {
        console.error('Erreur ouverture modale b√©n√©ficiaire :', err);
        showToast('Erreur lors du chargement du b√©n√©ficiaire', false);
      }
    });

    $('#form-edit-ref')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
      const fd = new FormData(e.target);
      const data = { id: fd.get('id') };
      for (const [k, v] of fd.entries()) if (k !== 'id' && k !== 'code') data[k] = String(v).trim();

      try {
        const r = await fetch('/api/admin/referrers-update', { method: 'POST', headers: { 'Content-Type': 'application/json', ...auth() }, body: JSON.stringify(data) });
        const j = await r.json();
        if (!r.ok) { document.querySelector('#modal-edit-ref [data-err="form"]').textContent = j.error || 'Erreur'; return; }
        closeModal('#modal-edit-ref'); showToast('B√©n√©ficiaire modifi√© ‚úÖ', true); loadReferrers(true);
      } catch (err) {
        document.querySelector('#modal-edit-ref [data-err="form"]').textContent = 'Erreur r√©seau';
      } finally { btn.disabled = false; }
    });

    // Bouton d'export unique (redirige vers l'export de l'onglet actif)
document.getElementById('export_fixed')?.addEventListener('click', ()=>{
  if (currentTab === 'tab_comm') {
    document.getElementById('comm_export')?.click();
  } else if (currentTab === 'tab_rib') {
    document.getElementById('rib_export')?.click();
  } else if (currentTab === 'tab_sales') {
    document.getElementById('sales_export')?.click();
  } else if (currentTab === 'tab_refs') {
    document.getElementById('refs_export')?.click();
  }
});

    // EXPORT CSV BENEFICIAIRES
    $('#refs_export')?.addEventListener('click', async () => {
      try {
        const p = { limit: '10000', offset: '0' };
        if (refsRib.value !== 'all') p.rib = refsRib.value;
        if (refsFrom.value) p.date_from = refsFrom.value;
        if (refsTo.value)   p.date_to   = refsTo.value;
        const q = (admSearchEl.value || '').trim(); if (q) p.search = q;

        const r = await fetch(`/api/admin/list-referrers?${new URLSearchParams(p).toString()}`, { headers: auth() });
        const j = await r.json(); if (!r.ok) { showToast(j.error || 'Export impossible', false); return; }

        const rows = Array.isArray(j.items) ? j.items : [];
        if (!rows.length) { showToast('Aucune donn√©e √† exporter', false); return; }

        const head = ['Commercial','Email','T√©l√©phone','Marque','Code','R√¥le','Code parrain','Statut RIB','Derni√®re activit√©'];
        const lines = [head.join(';')];
        rows.forEach(x => {
          const line = [
            `${(x.first_name||'')} ${(x.last_name||'')}`.trim(),
            x.email || '', x.phone || '', x.brand || '', x.code || '',
            x.role || '', x.role === 'filleul' ? (x.parent_code || '') : '',
            x.rib_status || 'missing',
            x.last_activity ? new Date(x.last_activity).toLocaleString() : ''
          ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(';');
          lines.push(line);
        });
        const csv  = '\uFEFF' + lines.join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const a    = document.createElement('a');
        a.href     = URL.createObjectURL(blob);
        a.download = `export-beneficiaires-${todayStr()}.csv`;
        document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      } catch (e) { console.error(e); showToast('Export impossible', false); }
    });

    // charge tout au d√©part
    function loadAll(reset){ loadCommissions(reset); loadRibs(reset); loadSales(reset); loadReferrers(reset); resizeScrollers(); }
    if (token()) { loadAll(true); refreshCommissionTotals(); }
  </script>
</body>
</html>
