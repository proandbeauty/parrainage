<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro&Beauty — Admin RIB</title>
  <style>
    body{margin:0;background:#0b0f14;color:#eaf2fb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px}
    .card{background:#121821;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    h1{margin:6px 0 14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input,select{background:#0f141c;border:1px solid rgba(255,255,255,.12);color:#eaf2fb;border-radius:10px;padding:10px}
    button{background:#5dd4a3;border:none;color:#06281c;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{background:#87e6be}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;vertical-align:top}
    th{color:#9fb0c3;text-align:left}
    .muted{color:#9fb0c3}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141c;border:1px solid rgba(255,255,255,.15);font-size:12px}
    .right{float:right}
    .btn-ghost{background:#0f141c;border:1px solid rgba(255,255,255,.12);color:#eaf2fb}
    .btn-red{background:#ff6b6b;color:#1b0b0b}
    .btn-red:hover{background:#ff8686}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin — RIB</h1>

      <div class="row">
        <input id="token" type="password" placeholder="ADMIN_TOKEN" style="min-width:260px" />
        <select id="status">
          <option value="pending">En attente</option>
          <option value="approved">Validé</option>
          <option value="rejected">Rejeté</option>
          <option value="all">Tous les statuts</option>
        </select>
        <input id="search" type="text" placeholder="Recherche: nom, email, IBAN, code..." style="flex:1" />
        <button id="load">Charger</button>
        <button id="export" class="btn-ghost">Exporter CSV</button>
      </div>

      <div id="msg" class="muted"></div>

      <table id="tab">
        <thead>
            <tr>
              <th data-sort="created_at" style="cursor:pointer">RIB ▲▼</th>
              <th data-sort="referrer"  style="cursor:default">Titulaire</th>
              <th data-sort="holder_name" style="cursor:pointer">IBAN (titulaire) ▲▼</th>
              <th style="cursor:default">Justificatif</th>
              <th style="cursor:default">Actions</th>
            </tr>
          </thead>
          
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Cliquez sur “Charger”.</td></tr>
        </tbody>
      </table>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="more">Charger +</button>
      </div>
    </div>
  </div>

  <script>
    const tbody   = document.getElementById('tbody');
    const msg     = document.getElementById('msg');
    const tokenEl = document.getElementById('token');
    const statusEl= document.getElementById('status');
    const searchEl= document.getElementById('search');
  
    let offset = 0, lastBatch = [];
  
    // TRI: état courant (par défaut: created_at desc)
    let sortBy  = 'created_at';
    let sortDir = 'desc'; // 'asc' | 'desc'
  
    // Mémorise le token admin
    tokenEl.value = localStorage.getItem('pnb_admin_token') || '';
    tokenEl.addEventListener('change', () => localStorage.setItem('pnb_admin_token', tokenEl.value.trim()));
  
    function fmtDate(iso){
      try { return new Date(iso).toLocaleString(); } catch { return iso || ''; }
    }
    function maskIban(iban){
      if(!iban) return '';
      const clean = String(iban).replace(/\s+/g,'');
      if(clean.length <= 8) return clean;
      return clean.slice(0,4) + ' •••• •••• •••• ' + clean.slice(-4);
    }
  
    function headerLabel(name){
      // met une petite flèche sur la colonne triée
      const up = ' ▲', down = ' ▼';
      if(name==='created_at'){
        return 'RIB' + (sortBy==='created_at' ? (sortDir==='asc'?up:down) : ' ▲▼');
      }
      if(name==='holder_name'){
        return 'IBAN (titulaire)' + (sortBy==='holder_name' ? (sortDir==='asc'?up:down) : ' ▲▼');
      }
      return name;
    }
  
    function refreshHeaderIndicators(){
      const thCreated = document.querySelector('th[data-sort="created_at"]');
      const thHolder  = document.querySelector('th[data-sort="holder_name"]');
      if(thCreated) thCreated.textContent = headerLabel('created_at').replace('created_at','RIB');
      if(thHolder)  thHolder.textContent  = headerLabel('holder_name').replace('holder_name','IBAN (titulaire)');
    }
  
    async function load(reset=true){
      try{
        if(reset){ offset = 0; tbody.innerHTML = '<tr><td colspan="5" class="muted">Chargement…</td></tr>'; }
        const url = `/api/admin/ribs-list?status=${encodeURIComponent(statusEl.value)}&limit=50&offset=${offset}&search=${encodeURIComponent(searchEl.value.trim())}&sort_by=${encodeURIComponent(sortBy)}&order=${encodeURIComponent(sortDir)}`;
        const r = await fetch(url, { headers:{ Authorization:'Bearer '+tokenEl.value.trim() } });
        const j = await r.json();
        if(!r.ok){ msg.textContent = j.error || 'Erreur'; return; }
        msg.textContent = '';
  
        if(reset) tbody.innerHTML = '';
        lastBatch = j.items || [];
  
        if(lastBatch.length===0 && offset===0){
          tbody.innerHTML = '<tr><td colspan="5" class="muted">Aucun RIB.</td></tr>';
          return;
        }
  
        for(const row of lastBatch){
          const ref = row.referrer || {}; // {first_name,last_name,email,referral_code}
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <div><b>${row.id}</b> <span class="pill">${row.status}</span></div>
              <div class="muted">${fmtDate(row.created_at)}</div>
            </td>
            <td>
              <div><b>${(ref.first_name||'')+' '+(ref.last_name||'')}</b></div>
              <div class="muted">${ref.email || ''}</div>
              <div class="muted">Code: ${ref.referral_code || ''}</div>
            </td>
            <td>
              <div><b>${maskIban(row.iban_masked || row.iban || '')}</b></div>
              <div class="muted">${row.bic ? ('BIC: '+row.bic) : ''}</div>
              <div class="muted">${row.holder_name ? ('Titulaire: '+row.holder_name) : ''}</div>
            </td>
            <td>
              ${row.doc_path ? `<button class="btn-ghost" data-action="proof" data-id="${row.id}">Voir justificatif</button>` : '<span class="muted">—</span>'}
            </td>
            <td>
              <button class="btn-ghost" data-action="approve" data-id="${row.id}">Valider</button>
              <button class="btn-red"   data-action="reject"  data-id="${row.id}">Rejeter</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
  
        offset = j.nextOffset ?? (offset + lastBatch.length);
        refreshHeaderIndicators();
      }catch(e){
        console.error(e);
        msg.textContent = 'Erreur chargement';
      }
    }
  
    async function setStatus(rib_id, status){
      try{
        const note = '';
        const r = await fetch('/api/admin/ribs-set-status', {
          method:'POST',
          headers: { 'Content-Type':'application/json', Authorization:'Bearer '+tokenEl.value.trim() },
          body: JSON.stringify({ id: rib_id, status, note })
        });
        const j = await r.json();
        if(!r.ok){ alert(j.error || 'Erreur'); return; }
        await load(true);
      }catch(e){
        console.error(e); alert('Erreur');
      }
    }
  
    async function openProof(rib_id){
      try{
        const r = await fetch(`/api/admin/ribs-proof?id=${encodeURIComponent(rib_id)}`, {
          headers:{ Authorization:'Bearer '+tokenEl.value.trim() }
        });
        const j = await r.json();
        if(!r.ok || !j.url){ alert(j.error || 'Justificatif indisponible'); return; }
        window.open(j.url, '_blank', 'noopener');
      }catch(e){
        console.error(e); alert('Impossible d’ouvrir le justificatif.');
      }
    }
  
    // Actions du bandeau
    document.getElementById('load').onclick = () => load(true);
    document.getElementById('more').onclick = () => load(false);
    document.getElementById('export').onclick = ()=>{
      const url = `/api/admin/ribs-list?status=${encodeURIComponent(statusEl.value)}&limit=10000&offset=0&search=${encodeURIComponent(searchEl.value.trim())}&format=csv&sort_by=${encodeURIComponent(sortBy)}&order=${encodeURIComponent(sortDir)}`;
      const a = document.createElement('a');
      a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.download = 'export-ribs.csv'; a.click();
    };
  
    // Délégation des clics sur le tableau
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if(action==='approve') setStatus(id, 'validated');
      else if(action==='reject') setStatus(id, 'rejected');
      else if(action==='proof') openProof(id);
    });
  
    // Clic sur en-têtes pour trier
    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const col = th.getAttribute('data-sort');
        if(col === 'referrer') return; // pas de tri sur la jointure dans cette version
        if(sortBy === col){
          sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
        } else {
          sortBy = col;
          sortDir = 'asc';
        }
        load(true);
      });
    });
  
    // Option: charger direct
    // load(true);
  </script>  
</body>
</html>
